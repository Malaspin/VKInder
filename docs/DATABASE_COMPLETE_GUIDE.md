# ๐๏ธ ะะพะปะฝะฐั ะดะพะบัะผะตะฝัะฐัะธั ะฑะฐะทั ะดะฐะฝะฝัั VKinder Bot

## ๐ ะะฑะทะพั ัะธััะตะผั

ะะพะปะฝะพัะตะฝะฝะฐั ัะธััะตะผะฐ ะดะปั ัะฐะฑะพัั ั ะฑะฐะทะพะน ะดะฐะฝะฝัั PostgreSQL ะฒ ะฟัะพะตะบัะต VKinder Bot, ะฒะบะปััะฐััะฐั:
- **ะะฝัะตััะตะนั ะฑะฐะทั ะดะฐะฝะฝัั** - ะพัะฝะพะฒะฝะพะน ะบะปะฐัั ะดะปั ัะฐะฑะพัั ั ะะ
- **CLI ะธะฝัะตััะตะนั** - ะบะพะผะฐะฝะดะฝะฐั ัััะพะบะฐ ะดะปั ัะฟัะฐะฒะปะตะฝะธั ะะ
- **API** - ะฒััะพะบะพััะพะฒะฝะตะฒัะต ััะฝะบัะธะธ ะดะปั ะธะฝัะตะณัะฐัะธะธ ั ะฑะพัะพะผ
- **ะะฒัะพะผะฐัะธะทะฐัะธั** - ะฐะฒัะพะผะฐัะธัะตัะบะธะน ะทะฐะฟััะบ PostgreSQL ะธ ัะพะทะดะฐะฝะธะต ะะ
- **ะจะธััะพะฒะฐะฝะธะต ัะพะบะตะฝะพะฒ** - ะฑะตะทะพะฟะฐัะฝะพะต ััะฐะฝะตะฝะธะต ะฟะพะปัะทะพะฒะฐัะตะปััะบะธั ัะพะบะตะฝะพะฒ
- **ะะพะณะธัะพะฒะฐะฝะธะต** - ะผะฝะพะณะพััะพะฒะฝะตะฒะฐั ัะธััะตะผะฐ ะปะพะณะธัะพะฒะฐะฝะธั ะฒ ะะ

## ๐๏ธ ะััะธัะตะบัััะฐ ัะธััะตะผั

### ะะพะผะฟะพะฝะตะฝัั ัะธััะตะผั:

```
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ                    VKinder Bot Application                 โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโค
โ  src/bot/database_integration.py  (BotDatabaseIntegration) โ
โ  โโโ ะัะพะผะตะถััะพัะฝัะน ัะปะพะน ะผะตะถะดั ะฑะพัะพะผ ะธ API                  โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโค
โ  src/database/db_api.py  (High-Level API)                  โ
โ  โโโ ะััะพะบะพััะพะฒะฝะตะฒัะต ััะฝะบัะธะธ ะดะปั ะฑะธะทะฝะตั-ะปะพะณะธะบะธ             โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโค
โ  src/database/database_interface.py  (DatabaseInterface)    โ
โ  โโโ ะะธะทะบะพััะพะฒะฝะตะฒัะต ะพะฟะตัะฐัะธะธ ั ะฑะฐะทะพะน ะดะฐะฝะฝัั                โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโค
โ  src/database/postgres_manager.py  (PostgreSQLManager)      โ
โ  โโโ ะฃะฟัะฐะฒะปะตะฝะธะต PostgreSQL ัะตัะฒะตัะพะผ                        โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโค
โ  PostgreSQL Database Server                                โ
โ  โโโ ะฅัะฐะฝะตะฝะธะต ะฒัะตั ะดะฐะฝะฝัั ะฟัะธะปะพะถะตะฝะธั                       โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
```

## ๐ ะัััััะน ััะฐัั

### 1. ะฃััะฐะฝะพะฒะบะฐ ะทะฐะฒะธัะธะผะพััะตะน
```bash
pip install -r requirements.txt
```

### 2. ะะฐัััะพะนะบะฐ ะฑะฐะทั ะดะฐะฝะฝัั
```bash
# ะกะพะทะดะฐะนัะต ัะฐะนะป .env ั ะฝะฐัััะพะนะบะฐะผะธ ะะ
cp env.example .env
# ะััะตะดะฐะบัะธััะนัะต .env ัะฐะนะป
```

### 3. ะกะพะทะดะฐะฝะธะต ัะฐะฑะปะธั
```bash
python src/database/db_cli.py create
```

### 4. ะัะพะฒะตัะบะฐ ััะฐัััะฐ
```bash
python src/database/db_cli.py info
```

## ๐ ะกัััะบัััะฐ ะฑะฐะทั ะดะฐะฝะฝัั

### ะขะฐะฑะปะธัั:

#### **vk_users** - ะะพะปัะทะพะฒะฐัะตะปะธ VK
```sql
CREATE TABLE vk_users (
    id SERIAL PRIMARY KEY,
    vk_user_id BIGINT UNIQUE NOT NULL,
    first_name VARCHAR(100) NOT NULL,
    last_name VARCHAR(100) NOT NULL,
    age INTEGER,
    sex INTEGER,  -- 1 - ะถะตะฝัะบะธะน, 2 - ะผัะถัะบะพะน
    city VARCHAR(100),
    city_id INTEGER,
    country VARCHAR(100),
    bdate VARCHAR(20),
    photo_url VARCHAR(500),
    profile_url VARCHAR(200),
    is_closed BOOLEAN DEFAULT FALSE,
    can_access_closed BOOLEAN DEFAULT FALSE,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);
```

#### **photos** - ะคะพัะพะณัะฐัะธะธ ะฟะพะปัะทะพะฒะฐัะตะปะตะน
```sql
CREATE TABLE photos (
    id SERIAL PRIMARY KEY,
    vk_user_id INTEGER REFERENCES vk_users(vk_user_id),
    photo_url TEXT NOT NULL,
    photo_type VARCHAR(50),
    likes_count INTEGER DEFAULT 0,
    found_by_user_id INTEGER REFERENCES vk_users(vk_user_id),
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);
```

#### **favorites** - ะะทะฑัะฐะฝะฝัะต ะฟะพะปัะทะพะฒะฐัะตะปะธ
```sql
CREATE TABLE favorites (
    id SERIAL PRIMARY KEY,
    user_vk_id INTEGER REFERENCES vk_users(vk_user_id),
    favorite_vk_id INTEGER REFERENCES vk_users(vk_user_id),
    added_at TIMESTAMP WITHOUT TIME ZONE DEFAULT CURRENT_TIMESTAMP,
    created_at TIMESTAMP WITHOUT TIME ZONE DEFAULT CURRENT_TIMESTAMP
);
```

#### **blacklisted** - ะงะตัะฝัะน ัะฟะธัะพะบ
```sql
CREATE TABLE blacklisted (
    id SERIAL PRIMARY KEY,
    user_vk_id INTEGER REFERENCES vk_users(vk_user_id),
    blocked_vk_id INTEGER REFERENCES vk_users(vk_user_id),
    blocked_at TIMESTAMP WITHOUT TIME ZONE DEFAULT CURRENT_TIMESTAMP,
    created_at TIMESTAMP WITHOUT TIME ZONE DEFAULT CURRENT_TIMESTAMP
);
```

#### **search_history** - ะััะพัะธั ะฟะพะธัะบะฐ
```sql
CREATE TABLE search_history (
    id SERIAL PRIMARY KEY,
    user_vk_id INTEGER REFERENCES vk_users(vk_user_id),
    results_count INTEGER DEFAULT 0,
    target_sex VARCHAR(20),
    age_from INTEGER,
    age_to INTEGER,
    city VARCHAR(100),
    city_id INTEGER,
    relationship_status VARCHAR(50),
    online BOOLEAN,
    searched_at TIMESTAMP WITHOUT TIME ZONE DEFAULT CURRENT_TIMESTAMP,
    created_at TIMESTAMP WITHOUT TIME ZONE DEFAULT CURRENT_TIMESTAMP
);
```

#### **user_settings** - ะะฐัััะพะนะบะธ ะฟะพะปัะทะพะฒะฐัะตะปะตะน
```sql
CREATE TABLE user_settings (
    id SERIAL PRIMARY KEY,
    vk_user_id INTEGER REFERENCES vk_users(vk_user_id) UNIQUE,
    min_age INTEGER DEFAULT 18,
    max_age INTEGER DEFAULT 35,
    sex_preference INTEGER,
    city_preference VARCHAR(100),
    relationship_status VARCHAR(50),
    online BOOLEAN DEFAULT FALSE,
    
    -- ะะพะปั ะดะปั ะทะฐัะธััะพะฒะฐะฝะฝัั ัะพะบะตะฝะพะฒ
    encrypted_access_token TEXT,
    encrypted_refresh_token TEXT,
    refresh_token_hash VARCHAR(128),
    token_salt VARCHAR(32),
    token_iv VARCHAR(24),
    token_expires_at TIMESTAMP WITH TIME ZONE,
    token_updated_at TIMESTAMP WITH TIME ZONE,
    
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);
```

#### **bot_logs** - ะะพะณะธ ัะธััะตะผั
```sql
CREATE TABLE bot_logs (
    id SERIAL PRIMARY KEY,
    vk_user_id INTEGER DEFAULT 0 NOT NULL,
    log_level VARCHAR(20) NOT NULL,
    log_message TEXT NOT NULL,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);
```

#### **bot_messages** - ะกะพะพะฑัะตะฝะธั ะฑะพัะฐ
```sql
CREATE TABLE bot_messages (
    id SERIAL PRIMARY KEY,
    vk_user_id INTEGER REFERENCES vk_users(vk_user_id),
    message_type VARCHAR(50) NOT NULL,
    message_text TEXT NOT NULL,
    sent_at TIMESTAMP WITHOUT TIME ZONE DEFAULT CURRENT_TIMESTAMP
);
```

## ๐ง ะัะฝะพะฒะฝัะต ะบะพะผะฟะพะฝะตะฝัั

### DatabaseInterface
ะัะฝะพะฒะฝะพะน ะบะปะฐัั ะดะปั ัะฐะฑะพัั ั PostgreSQL:
- ะะพะดะบะปััะตะฝะธะต ะบ ะฑะฐะทะต ะดะฐะฝะฝัั
- CRUD ะพะฟะตัะฐัะธะธ
- ะฃะฟัะฐะฒะปะตะฝะธะต ัะฐะฑะปะธัะฐะผะธ
- ะะฑัะฐะฑะพัะบะฐ ะพัะธะฑะพะบ
- **ะะฒัะพะผะฐัะธัะตัะบะธะน ะทะฐะฟััะบ PostgreSQL**

### PostgreSQLManager
ะะตะฝะตะดะถะตั ะดะปั ัะฟัะฐะฒะปะตะฝะธั PostgreSQL:
- ะัะพะฒะตัะบะฐ ััะฐัััะฐ PostgreSQL
- ะะฒัะพะผะฐัะธัะตัะบะธะน ะทะฐะฟััะบ ัะตัะตะท Homebrew
- ะกะพะทะดะฐะฝะธะต ะฑะฐะทั ะดะฐะฝะฝัั
- ะะพะปััะตะฝะธะต ะธะฝัะพัะผะฐัะธะธ ะพ PostgreSQL
- **ะััะธัะพะฒะฐะฝะธะต ััะฐัััะฐ** ะดะปั ะพะฟัะธะผะธะทะฐัะธะธ

### CLI ะธะฝัะตััะตะนั (db_cli.py)
ะะพะผะฐะฝะดะฝะฐั ัััะพะบะฐ ะดะปั ัะฟัะฐะฒะปะตะฝะธั ะะ:

#### ๐๏ธ ะฃะฟัะฐะฒะปะตะฝะธะต ััััะบัััะพะน ะฑะฐะทั ะดะฐะฝะฝัั

**`create` - ะกะพะทะดะฐะฝะธะต ัะฐะฑะปะธั**
```bash
python src/database/db_cli.py create
```
ะกะพะทะดะฐะตั ะฒัะต ัะฐะฑะปะธัั ะฑะฐะทั ะดะฐะฝะฝัั ัะพะณะปะฐัะฝะพ ะผะพะดะตะปัะผ SQLAlchemy.

**`drop` - ะฃะดะฐะปะตะฝะธะต ะฒัะตั ัะฐะฑะปะธั**
```bash
python src/database/db_cli.py drop
```
โ๏ธ **ะะะะะะะะ:** ะญัะฐ ะบะพะผะฐะฝะดะฐ ัะดะฐะปัะตั ะะกะ ะดะฐะฝะฝัะต!

#### ๐งน ะฃะฟัะฐะฒะปะตะฝะธะต ะดะฐะฝะฝัะผะธ

**`clear <table_name>` - ะัะธััะบะฐ ะบะพะฝะบัะตัะฝะพะน ัะฐะฑะปะธัั**
```bash
python src/database/db_cli.py clear <table_name>
```

ะะพัััะฟะฝัะต ัะฐะฑะปะธัั:
- `vk_users` - ะะพะปัะทะพะฒะฐัะตะปะธ
- `photos` - ะคะพัะพะณัะฐัะธะธ
- `favorites` - ะะทะฑัะฐะฝะฝะพะต
- `blacklisted` - ะงะตัะฝัะน ัะฟะธัะพะบ
- `search_history` - ะััะพัะธั ะฟะพะธัะบะฐ
- `user_settings` - ะะฐัััะพะนะบะธ
- `bot_logs` - ะะพะณะธ
- `bot_messages` - ะกะพะพะฑัะตะฝะธั

**`clear-all` - ะัะธััะบะฐ ะฒัะตั ัะฐะฑะปะธั**
```bash
python src/database/db_cli.py clear-all
```
โ๏ธ **ะะะะะะะะ:** ะญัะฐ ะบะพะผะฐะฝะดะฐ ัะดะฐะปัะตั ะะกะ ะดะฐะฝะฝัะต ะธะท ะฒัะตั ัะฐะฑะปะธั!

#### ๐ ะะพะฝะธัะพัะธะฝะณ ะธ ะดะธะฐะณะฝะพััะธะบะฐ

**`info` - ะะฝัะพัะผะฐัะธั ะพ ะฑะฐะทะต ะดะฐะฝะฝัั**
```bash
python src/database/db_cli.py info
```
ะะพะบะฐะทัะฒะฐะตั ะฟะพะดัะพะฑะฝัั ะธะฝัะพัะผะฐัะธั ะพ ะฒัะตั ัะฐะฑะปะธัะฐั ะฑะฐะทั ะดะฐะฝะฝัั.

**`logs` - ะัะพัะผะพัั ะปะพะณะพะฒ**
```bash
python src/database/db_cli.py logs [ะพะฟัะธะธ]
```

ะะฟัะธะธ:
- `--user <user_id>` - ะะพะณะธ ะบะพะฝะบัะตัะฝะพะณะพ ะฟะพะปัะทะพะฒะฐัะตะปั
- `--level <level>` - ะคะธะปััั ะฟะพ ััะพะฒะฝั (DEBUG, INFO, WARNING, ERROR)
- `--limit <n>` - ะะพะปะธัะตััะฒะพ ะทะฐะฟะธัะตะน (ะฟะพ ัะผะพะปัะฐะฝะธั 50)

ะัะธะผะตัั:
```bash
# ะัะต ะปะพะณะธ (ะฟะพัะปะตะดะฝะธะต 50)
python src/database/db_cli.py logs

# ะะพะณะธ ะบะพะฝะบัะตัะฝะพะณะพ ะฟะพะปัะทะพะฒะฐัะตะปั
python src/database/db_cli.py logs --user 123456789

# ะขะพะปัะบะพ ะพัะธะฑะบะธ
python src/database/db_cli.py logs --level ERROR --limit 10
```

**`messages <user_id>` - ะกะพะพะฑัะตะฝะธั ะฟะพะปัะทะพะฒะฐัะตะปั**
```bash
python src/database/db_cli.py messages <user_id> [ะพะฟัะธะธ]
```

**`favorites <user_id>` - ะะทะฑัะฐะฝะฝัะต ะฟะพะปัะทะพะฒะฐัะตะปั**
```bash
python src/database/db_cli.py favorites <user_id>
```

#### ๐งช ะขะตััะธัะพะฒะฐะฝะธะต

**`test-data` - ะะพะฑะฐะฒะปะตะฝะธะต ัะตััะพะฒัั ะดะฐะฝะฝัั**
```bash
python src/database/db_cli.py test-data
```

#### ๐ ะฃะฟัะฐะฒะปะตะฝะธะต PostgreSQL

**`postgres-start` - ะะฐะฟััะบ PostgreSQL**
```bash
python src/database/db_cli.py postgres-start
```

**`postgres-stop` - ะััะฐะฝะพะฒะบะฐ PostgreSQL**
```bash
python src/database/db_cli.py postgres-stop
```

**`postgres-restart` - ะะตัะตะทะฐะฟััะบ PostgreSQL**
```bash
python src/database/db_cli.py postgres-restart
```

**`postgres-status` - ะกัะฐััั PostgreSQL**
```bash
python src/database/db_cli.py postgres-status
```

**`postgres-info` - ะะฝัะพัะผะฐัะธั ะพ PostgreSQL**
```bash
python src/database/db_cli.py postgres-info
```

## ๐ API ะคัะฝะบัะธะธ

### ๐ ะฃะฟัะฐะฒะปะตะฝะธะต ะฟะพะปัะทะพะฒะฐัะตะปัะผะธ

#### `save_user(user_data: dict) -> bool`
**ะะฐะทะฝะฐัะตะฝะธะต:** ะกะพััะฐะฝัะตั ะธะปะธ ะพะฑะฝะพะฒะปัะตั ะฟะพะปัะทะพะฒะฐัะตะปั ะฒ ะฑะฐะทะต ะดะฐะฝะฝัั.

**ะะฐัะฐะผะตััั:**
- `user_data` (dict): ะกะปะพะฒะฐัั ั ะดะฐะฝะฝัะผะธ ะฟะพะปัะทะพะฒะฐัะตะปั
  - `id` (int): VK ID ะฟะพะปัะทะพะฒะฐัะตะปั
  - `first_name` (str): ะะผั
  - `last_name` (str): ะคะฐะผะธะปะธั
  - `sex` (int): ะะพะป (1-ะถะตะฝัะบะธะน, 2-ะผัะถัะบะพะน)
  - `bdate` (str): ะะฐัะฐ ัะพะถะดะตะฝะธั
  - `city` (dict): ะะพัะพะด `{'id': int, 'title': str}`
  - `photo_url` (str): URL ะณะปะฐะฒะฝะพะณะพ ัะพัะพ

**ะะพะทะฒัะฐัะฐะตั:** `bool` - True ะตัะปะธ ััะฟะตัะฝะพ ัะพััะฐะฝะตะฝะพ

**ะัะธะผะตั ะธัะฟะพะปัะทะพะฒะฐะฝะธั:**
```python
from database.db_api import save_user

user_data = {
    'id': 123456789,
    'first_name': 'ะะฝะฝะฐ',
    'last_name': 'ะะตััะพะฒะฐ',
    'sex': 1,
    'bdate': '15.05.1990',
    'city': {'id': 1, 'title': 'ะะพัะบะฒะฐ'},
    'photo_url': 'https://vk.com/photo123'
}

success = save_user(user_data)
if success:
    print("ะะพะปัะทะพะฒะฐัะตะปั ัะพััะฐะฝะตะฝ ััะฟะตัะฝะพ")
```

#### `get_user(user_id: int) -> dict`
**ะะฐะทะฝะฐัะตะฝะธะต:** ะะพะปััะฐะตั ะดะฐะฝะฝัะต ะฟะพะปัะทะพะฒะฐัะตะปั ะฟะพ VK ID.

#### `get_all_users() -> list`
**ะะฐะทะฝะฐัะตะฝะธะต:** ะะพะปััะฐะตั ัะฟะธัะพะบ ะฒัะตั ะฟะพะปัะทะพะฒะฐัะตะปะตะน.

### ๐ฌ ะฃะฟัะฐะฒะปะตะฝะธะต ัะพะพะฑัะตะฝะธัะผะธ

#### `save_message(user_id: int, message: str, message_type: str = 'user') -> bool`
**ะะฐะทะฝะฐัะตะฝะธะต:** ะกะพััะฐะฝัะตั ัะพะพะฑัะตะฝะธะต ะฒ ะฑะฐะทั ะดะฐะฝะฝัั.

#### `get_messages(user_id: int, limit: int = 50) -> list`
**ะะฐะทะฝะฐัะตะฝะธะต:** ะะพะปััะฐะตั ัะพะพะฑัะตะฝะธั ะฟะพะปัะทะพะฒะฐัะตะปั.

### โค๏ธ ะฃะฟัะฐะฒะปะตะฝะธะต ะธะทะฑัะฐะฝะฝัะผ

#### `add_to_favorites(user_id: int, favorite_id: int) -> bool`
**ะะฐะทะฝะฐัะตะฝะธะต:** ะะพะฑะฐะฒะปัะตั ะฟะพะปัะทะพะฒะฐัะตะปั ะฒ ะธะทะฑัะฐะฝะฝะพะต.

**ะัะฐะฒะธะปะฐ ะธัะฟะพะปัะทะพะฒะฐะฝะธั:**
- ะัะปะธ ะฟะพะปัะทะพะฒะฐัะตะปั ัะถะต ะฒ ะธะทะฑัะฐะฝะฝะพะผ, ะพะฑะฝะพะฒะปัะตััั `added_at`
- ะะต ัะพะทะดะฐะตััั ะดัะฑะปะธะบะฐั ะทะฐะฟะธัะธ

#### `get_favorites(user_id: int, limit: int = 10) -> list`
**ะะฐะทะฝะฐัะตะฝะธะต:** ะะพะปััะฐะตั ัะฟะธัะพะบ ะธะทะฑัะฐะฝะฝัั ะฟะพะปัะทะพะฒะฐัะตะปะตะน.

#### `remove_from_favorites(user_id: int, favorite_id: int) -> bool`
**ะะฐะทะฝะฐัะตะฝะธะต:** ะฃะดะฐะปัะตั ะฟะพะปัะทะพะฒะฐัะตะปั ะธะท ะธะทะฑัะฐะฝะฝะพะณะพ.

#### `is_in_favorites(user_id: int, target_id: int) -> bool`
**ะะฐะทะฝะฐัะตะฝะธะต:** ะัะพะฒะตััะตั, ะฝะฐัะพะดะธััั ะปะธ ะฟะพะปัะทะพะฒะฐัะตะปั ะฒ ะธะทะฑัะฐะฝะฝะพะผ.

### ๐ซ ะฃะฟัะฐะฒะปะตะฝะธะต ัะตัะฝัะผ ัะฟะธัะบะพะผ

#### `add_to_blacklist(user_id: int, blacklisted_id: int) -> bool`
**ะะฐะทะฝะฐัะตะฝะธะต:** ะะพะฑะฐะฒะปัะตั ะฟะพะปัะทะพะฒะฐัะตะปั ะฒ ัะตัะฝัะน ัะฟะธัะพะบ.

#### `get_blacklist(user_id: int) -> list`
**ะะฐะทะฝะฐัะตะฝะธะต:** ะะพะปััะฐะตั ัะฟะธัะพะบ ะทะฐะฑะปะพะบะธัะพะฒะฐะฝะฝัั ะฟะพะปัะทะพะฒะฐัะตะปะตะน.

#### `remove_from_blacklist(user_id: int, blacklisted_id: int) -> bool`
**ะะฐะทะฝะฐัะตะฝะธะต:** ะฃะดะฐะปัะตั ะฟะพะปัะทะพะฒะฐัะตะปั ะธะท ัะตัะฝะพะณะพ ัะฟะธัะบะฐ.

#### `is_user_blacklisted(user_id: int, target_user_id: int) -> bool`
**ะะฐะทะฝะฐัะตะฝะธะต:** ะัะพะฒะตััะตั, ะฝะฐัะพะดะธััั ะปะธ ะฟะพะปัะทะพะฒะฐัะตะปั ะฒ ัะตัะฝะพะผ ัะฟะธัะบะต.

### ๐ธ ะฃะฟัะฐะฒะปะตะฝะธะต ัะพัะพะณัะฐัะธัะผะธ

#### `save_photos(user_id: int, photos_data: list) -> bool`
**ะะฐะทะฝะฐัะตะฝะธะต:** ะกะพััะฐะฝัะตั ัะพัะพะณัะฐัะธะธ ะฟะพะปัะทะพะฒะฐัะตะปั.

**ะะฐัะฐะผะตััั:**
- `user_id` (int): VK ID ะฟะพะปัะทะพะฒะฐัะตะปั
- `photos_data` (list): ะกะฟะธัะพะบ ัะปะพะฒะฐัะตะน ั ะดะฐะฝะฝัะผะธ ัะพัะพะณัะฐัะธะน
  - `url` (str): URL ัะพัะพะณัะฐัะธะธ
  - `likes_count` (int): ะะพะปะธัะตััะฒะพ ะปะฐะนะบะพะฒ
  - `photo_type` (str): ะขะธะฟ ัะพัะพะณัะฐัะธะธ ('profile' ะธะปะธ 'tagged')

**ะัะฐะฒะธะปะฐ ะธัะฟะพะปัะทะพะฒะฐะฝะธั:**
- ะัะปะธ ัะพัะพะณัะฐัะธั ัะถะต ัััะตััะฒัะตั, ะพะฑะฝะพะฒะปัะตััั `likes_count`
- ะะต ัะพะทะดะฐะตััั ะดัะฑะปะธะบะฐั ะทะฐะฟะธัะธ

#### `get_photos(user_id: int) -> list`
**ะะฐะทะฝะฐัะตะฝะธะต:** ะะพะปััะฐะตั ัะพัะพะณัะฐัะธะธ ะฟะพะปัะทะพะฒะฐัะตะปั.

### โ๏ธ ะฃะฟัะฐะฒะปะตะฝะธะต ะฝะฐัััะพะนะบะฐะผะธ

#### `save_user_settings(user_id: int, settings: dict) -> bool`
**ะะฐะทะฝะฐัะตะฝะธะต:** ะกะพััะฐะฝัะตั ะฝะฐัััะพะนะบะธ ะฟะพะปัะทะพะฒะฐัะตะปั.

#### `get_user_settings(user_id: int) -> dict`
**ะะฐะทะฝะฐัะตะฝะธะต:** ะะพะปััะฐะตั ะฝะฐัััะพะนะบะธ ะฟะพะปัะทะพะฒะฐัะตะปั.

### ๐ ะะดะผะธะฝะธัััะฐัะธะฒะฝัะต ััะฝะบัะธะธ

#### `get_database_stats() -> dict`
**ะะฐะทะฝะฐัะตะฝะธะต:** ะะพะปััะฐะตั ะพะฑััั ััะฐัะธััะธะบั ะฑะฐะทั ะดะฐะฝะฝัั.

#### `get_table_list() -> list`
**ะะฐะทะฝะฐัะตะฝะธะต:** ะะพะปััะฐะตั ัะฟะธัะพะบ ะฒัะตั ัะฐะฑะปะธั.

#### `get_table_info(table_name: str) -> dict`
**ะะฐะทะฝะฐัะตะฝะธะต:** ะะพะปััะฐะตั ะดะตัะฐะปัะฝัั ะธะฝัะพัะผะฐัะธั ะพ ัะฐะฑะปะธัะต.

#### `get_all_tables_info() -> dict`
**ะะฐะทะฝะฐัะตะฝะธะต:** ะะพะปััะฐะตั ะธะฝัะพัะผะฐัะธั ะพ ะฒัะตั ัะฐะฑะปะธัะฐั ะทะฐ ะพะดะธะฝ ะทะฐะฟัะพั (ะพะฟัะธะผะธะทะธัะพะฒะฐะฝะฝะพ).

### ๐ ะฃะฟัะฐะฒะปะตะฝะธะต ัะพะบะตะฝะฐะผะธ

#### `save_user_tokens(vk_user_id: int, access_token: str, refresh_token: str, expires_in: int = 3600) -> bool`
**ะะฐะทะฝะฐัะตะฝะธะต:** ะกะพััะฐะฝัะตั ะทะฐัะธััะพะฒะฐะฝะฝัะต ัะพะบะตะฝั ะฟะพะปัะทะพะฒะฐัะตะปั ะฒ ะฑะฐะทั ะดะฐะฝะฝัั.

**ะะฐัะฐะผะตััั:**
- `vk_user_id` (int): VK ID ะฟะพะปัะทะพะฒะฐัะตะปั
- `access_token` (str): Access ัะพะบะตะฝ ะดะปั ะฒัะฟะพะปะฝะตะฝะธั ะทะฐะฟัะพัะพะฒ ะบ VK API
- `refresh_token` (str): Refresh ัะพะบะตะฝ ะดะปั ะพะฑะฝะพะฒะปะตะฝะธั access ัะพะบะตะฝะฐ
- `expires_in` (int, ะพะฟัะธะพะฝะฐะปัะฝะพ): ะัะตะผั ะถะธะทะฝะธ access ัะพะบะตะฝะฐ ะฒ ัะตะบัะฝะดะฐั (ะฟะพ ัะผะพะปัะฐะฝะธั 3600)

**ะะพะทะฒัะฐัะฐะตั:** `bool` - True ะตัะปะธ ัะพะบะตะฝั ััะฟะตัะฝะพ ัะพััะฐะฝะตะฝั ะธ ะทะฐัะธััะพะฒะฐะฝั

**ะงัะพ ะฟัะพะธััะพะดะธั ะฒะฝัััะธ:**
1. ะะฒัะพะผะฐัะธัะตัะบะพะต ัะธััะพะฒะฐะฝะธะต access ัะพะบะตะฝะฐ ั ะฟะพะผะพััั AES-256
2. ะะฒัะพะผะฐัะธัะตัะบะพะต ัะธััะพะฒะฐะฝะธะต refresh ัะพะบะตะฝะฐ ั ะฟะพะผะพััั AES-256
3. ะะตะฝะตัะฐัะธั ัะตัะฐ refresh ัะพะบะตะฝะฐ ั ัะพะปัั ะดะปั ะฑััััะพะน ะฟัะพะฒะตัะบะธ
4. ะกะพััะฐะฝะตะฝะธะต ะฒัะตั ะดะฐะฝะฝัั ะฒ ัะฐะฑะปะธัั `user_settings`
5. ะกะพะทะดะฐะฝะธะต ะฟะพะปัะทะพะฒะฐัะตะปั ะฒ `vk_users` ะตัะปะธ ะฝะต ัััะตััะฒัะตั

**ะัะธะผะตั ะธัะฟะพะปัะทะพะฒะฐะฝะธั:**
```python
from src.database.database_interface import DatabaseInterface

db = DatabaseInterface()

success = db.save_user_tokens(
    vk_user_id=9197005,
    access_token="vk1.a.abc123def456...",
    refresh_token="vk2.a.refresh789...",
    expires_in=3600
)

if success:
    print("โ ะขะพะบะตะฝั ัะพััะฐะฝะตะฝั ะธ ะทะฐัะธััะพะฒะฐะฝั")
else:
    print("โ ะัะธะฑะบะฐ ัะพััะฐะฝะตะฝะธั ัะพะบะตะฝะพะฒ")
```

#### `get_user_access_token(vk_user_id: int) -> Optional[str]`
**ะะฐะทะฝะฐัะตะฝะธะต:** ะะพะปััะฐะตั ัะฐััะธััะพะฒะฐะฝะฝัะน access ัะพะบะตะฝ ะฟะพะปัะทะพะฒะฐัะตะปั.

**ะะฐัะฐะผะตััั:**
- `vk_user_id` (int): VK ID ะฟะพะปัะทะพะฒะฐัะตะปั

**ะะพะทะฒัะฐัะฐะตั:** `Optional[str]` - ะะฐััะธััะพะฒะฐะฝะฝัะน access ัะพะบะตะฝ ะธะปะธ None ะตัะปะธ ะฝะต ะฝะฐะนะดะตะฝ/ะธััะตะบ

**ะงัะพ ะฟัะพะธััะพะดะธั ะฒะฝัััะธ:**
1. ะะพะธัะบ ะฟะพะปัะทะพะฒะฐัะตะปั ะฒ ัะฐะฑะปะธัะต `user_settings`
2. ะัะพะฒะตัะบะฐ ะฝะฐะปะธัะธั ะทะฐัะธััะพะฒะฐะฝะฝะพะณะพ access ัะพะบะตะฝะฐ
3. ะัะพะฒะตัะบะฐ ะฒัะตะผะตะฝะธ ะธััะตัะตะฝะธั ัะพะบะตะฝะฐ
4. ะะฒัะพะผะฐัะธัะตัะบะพะต ะดะตัะธััะพะฒะฐะฝะธะต ัะพะบะตะฝะฐ ั ะฟะพะผะพััั AES-256
5. ะะพะทะฒัะฐั ะณะพัะพะฒะพะณะพ ะบ ะธัะฟะพะปัะทะพะฒะฐะฝะธั ัะพะบะตะฝะฐ

**ะัะธะผะตั ะธัะฟะพะปัะทะพะฒะฐะฝะธั:**
```python
access_token = db.get_user_access_token(9197005)

if access_token:
    print(f"โ Access ัะพะบะตะฝ ะฟะพะปััะตะฝ: {access_token[:20]}...")
    # ะัะฟะพะปัะทัะตะผ ัะพะบะตะฝ ะดะปั ะทะฐะฟัะพัะพะฒ ะบ VK API
else:
    print("โ ะขะพะบะตะฝ ะฝะต ะฝะฐะนะดะตะฝ ะธะปะธ ะธััะตะบ")
```

#### `get_user_refresh_token_decrypted(vk_user_id: int) -> Optional[str]`
**ะะฐะทะฝะฐัะตะฝะธะต:** ะะพะปััะฐะตั ัะฐััะธััะพะฒะฐะฝะฝัะน refresh ัะพะบะตะฝ ะฟะพะปัะทะพะฒะฐัะตะปั.

**ะะฐัะฐะผะตััั:**
- `vk_user_id` (int): VK ID ะฟะพะปัะทะพะฒะฐัะตะปั

**ะะพะทะฒัะฐัะฐะตั:** `Optional[str]` - ะะฐััะธััะพะฒะฐะฝะฝัะน refresh ัะพะบะตะฝ ะธะปะธ None ะตัะปะธ ะฝะต ะฝะฐะนะดะตะฝ

**ะงัะพ ะฟัะพะธััะพะดะธั ะฒะฝัััะธ:**
1. ะะพะธัะบ ะฟะพะปัะทะพะฒะฐัะตะปั ะฒ ัะฐะฑะปะธัะต `user_settings`
2. ะัะพะฒะตัะบะฐ ะฝะฐะปะธัะธั ะทะฐัะธััะพะฒะฐะฝะฝะพะณะพ refresh ัะพะบะตะฝะฐ
3. ะะฒัะพะผะฐัะธัะตัะบะพะต ะดะตัะธััะพะฒะฐะฝะธะต ัะพะบะตะฝะฐ ั ะฟะพะผะพััั AES-256

**ะัะธะผะตั ะธัะฟะพะปัะทะพะฒะฐะฝะธั:**
```python
refresh_token = db.get_user_refresh_token_decrypted(9197005)

if refresh_token:
    print(f"โ Refresh ัะพะบะตะฝ ะฟะพะปััะตะฝ: {refresh_token[:20]}...")
    # ะัะฟะพะปัะทัะตะผ ัะพะบะตะฝ ะดะปั ะพะฑะฝะพะฒะปะตะฝะธั access ัะพะบะตะฝะฐ
else:
    print("โ Refresh ัะพะบะตะฝ ะฝะต ะฝะฐะนะดะตะฝ")
```

#### `verify_user_refresh_token(vk_user_id: int, refresh_token: str) -> bool`
**ะะฐะทะฝะฐัะตะฝะธะต:** ะัะพะฒะตััะตั ะฒะฐะปะธะดะฝะพััั refresh ัะพะบะตะฝะฐ ะฟะพะปัะทะพะฒะฐัะตะปั.

**ะะฐัะฐะผะตััั:**
- `vk_user_id` (int): VK ID ะฟะพะปัะทะพะฒะฐัะตะปั
- `refresh_token` (str): Refresh ัะพะบะตะฝ ะดะปั ะฟัะพะฒะตัะบะธ

**ะะพะทะฒัะฐัะฐะตั:** `bool` - True ะตัะปะธ ัะพะบะตะฝ ะฒะฐะปะธะดะตะฝ, False ะธะฝะฐัะต

**ะงัะพ ะฟัะพะธััะพะดะธั ะฒะฝัััะธ:**
1. ะะพะธัะบ ะฟะพะปัะทะพะฒะฐัะตะปั ะฒ ัะฐะฑะปะธัะต `user_settings`
2. ะะพะปััะตะฝะธะต ัะพััะฐะฝะตะฝะฝะพะณะพ ัะตัะฐ ะธ ัะพะปะธ
3. ะฅะตัะธัะพะฒะฐะฝะธะต ะฟะตัะตะดะฐะฝะฝะพะณะพ ัะพะบะตะฝะฐ ั ัะพะน ะถะต ัะพะปัั
4. ะกัะฐะฒะฝะตะฝะธะต ะฟะพะปััะตะฝะฝะพะณะพ ัะตัะฐ ั ัะพััะฐะฝะตะฝะฝัะผ

**ะัะธะผะตั ะธัะฟะพะปัะทะพะฒะฐะฝะธั:**
```python
is_valid = db.verify_user_refresh_token(9197005, "vk2.a.refresh789...")

if is_valid:
    print("โ Refresh ัะพะบะตะฝ ะฒะฐะปะธะดะตะฝ")
else:
    print("โ Refresh ัะพะบะตะฝ ะฝะตะฒะฐะปะธะดะตะฝ")
```

#### `is_user_token_expired(vk_user_id: int) -> bool`
**ะะฐะทะฝะฐัะตะฝะธะต:** ะัะพะฒะตััะตั, ะธััะตะบ ะปะธ access ัะพะบะตะฝ ะฟะพะปัะทะพะฒะฐัะตะปั.

**ะะฐัะฐะผะตััั:**
- `vk_user_id` (int): VK ID ะฟะพะปัะทะพะฒะฐัะตะปั

**ะะพะทะฒัะฐัะฐะตั:** `bool` - True ะตัะปะธ ัะพะบะตะฝ ะธััะตะบ, False ะตัะปะธ ะตัะต ะดะตะนััะฒะธัะตะปะตะฝ

**ะงัะพ ะฟัะพะธััะพะดะธั ะฒะฝัััะธ:**
1. ะะพะธัะบ ะฟะพะปัะทะพะฒะฐัะตะปั ะฒ ัะฐะฑะปะธัะต `user_settings`
2. ะะพะปััะตะฝะธะต ะฒัะตะผะตะฝะธ ะธััะตัะตะฝะธั ัะพะบะตะฝะฐ (`token_expires_at`)
3. ะกัะฐะฒะฝะตะฝะธะต ั ัะตะบััะธะผ ะฒัะตะผะตะฝะตะผ
4. ะฃัะตั ัะฐัะพะฒะพะณะพ ะฟะพััะฐ (UTC)

**ะัะธะผะตั ะธัะฟะพะปัะทะพะฒะฐะฝะธั:**
```python
is_expired = db.is_user_token_expired(9197005)

if is_expired:
    print("โ๏ธ ะขะพะบะตะฝ ะธััะตะบ, ััะตะฑัะตััั ะพะฑะฝะพะฒะปะตะฝะธะต")
else:
    print("โ ะขะพะบะตะฝ ะตัะต ะดะตะนััะฒะธัะตะปะตะฝ")
```

#### `update_user_tokens(vk_user_id: int, access_token: Optional[str] = None, refresh_token: Optional[str] = None, expires_in: Optional[int] = None) -> bool`
**ะะฐะทะฝะฐัะตะฝะธะต:** ะะฑะฝะพะฒะปัะตั ัะพะบะตะฝั ะฟะพะปัะทะพะฒะฐัะตะปั (ัะฐััะธัะฝะพ ะธะปะธ ะฟะพะปะฝะพัััั).

**ะะฐัะฐะผะตััั:**
- `vk_user_id` (int): VK ID ะฟะพะปัะทะพะฒะฐัะตะปั
- `access_token` (Optional[str]): ะะพะฒัะน access ัะพะบะตะฝ (ะพะฟัะธะพะฝะฐะปัะฝะพ)
- `refresh_token` (Optional[str]): ะะพะฒัะน refresh ัะพะบะตะฝ (ะพะฟัะธะพะฝะฐะปัะฝะพ)
- `expires_in` (Optional[int]): ะะพะฒะพะต ะฒัะตะผั ะถะธะทะฝะธ ะฒ ัะตะบัะฝะดะฐั (ะพะฟัะธะพะฝะฐะปัะฝะพ)

**ะะพะทะฒัะฐัะฐะตั:** `bool` - True ะตัะปะธ ะพะฑะฝะพะฒะปะตะฝะธะต ััะฟะตัะฝะพ

**ะงัะพ ะฟัะพะธััะพะดะธั ะฒะฝัััะธ:**
1. ะะพะธัะบ ะฟะพะปัะทะพะฒะฐัะตะปั ะฒ ัะฐะฑะปะธัะต `user_settings`
2. ะะฒัะพะผะฐัะธัะตัะบะพะต ัะธััะพะฒะฐะฝะธะต ะฝะพะฒัั ัะพะบะตะฝะพะฒ (ะตัะปะธ ะฟะตัะตะดะฐะฝั)
3. ะะฑะฝะพะฒะปะตะฝะธะต ัะพะปัะบะพ ะฟะตัะตะดะฐะฝะฝัั ะฟะพะปะตะน
4. ะะฑะฝะพะฒะปะตะฝะธะต ะฒัะตะผะตะฝะธ ะฟะพัะปะตะดะฝะตะณะพ ะธะทะผะตะฝะตะฝะธั

**ะัะธะผะตั ะธัะฟะพะปัะทะพะฒะฐะฝะธั:**
```python
# ะะฑะฝะพะฒะปัะตะผ ัะพะปัะบะพ access ัะพะบะตะฝ
success = db.update_user_tokens(
    vk_user_id=9197005,
    access_token="vk1.a.new_access_token...",
    expires_in=3600
)

# ะะฑะฝะพะฒะปัะตะผ ะพะฑะฐ ัะพะบะตะฝะฐ
success = db.update_user_tokens(
    vk_user_id=9197005,
    access_token="vk1.a.new_access_token...",
    refresh_token="vk2.a.new_refresh_token...",
    expires_in=3600
)
```

#### `get_user_token_info(vk_user_id: int) -> dict`
**ะะฐะทะฝะฐัะตะฝะธะต:** ะะพะปััะฐะตั ะฟะพะปะฝัั ะธะฝัะพัะผะฐัะธั ะพ ัะพะบะตะฝะฐั ะฟะพะปัะทะพะฒะฐัะตะปั.

**ะะฐัะฐะผะตััั:**
- `vk_user_id` (int): VK ID ะฟะพะปัะทะพะฒะฐัะตะปั

**ะะพะทะฒัะฐัะฐะตั:** `dict` - ะกะปะพะฒะฐัั ั ะธะฝัะพัะผะฐัะธะตะน ะพ ัะพะบะตะฝะฐั

**ะกัััะบัััะฐ ะฒะพะทะฒัะฐัะฐะตะผะพะณะพ ัะปะพะฒะฐัั:**
```python
{
    'has_tokens': bool,           # ะััั ะปะธ ัะพะบะตะฝั ะฒ ะะ
    'is_expired': bool,           # ะััะตะบ ะปะธ ัะพะบะตะฝ
    'expires_at': str,           # ะัะตะผั ะธััะตัะตะฝะธั (ISO ัะพัะผะฐั)
    'updated_at': str,           # ะัะตะผั ะฟะพัะปะตะดะฝะตะณะพ ะพะฑะฝะพะฒะปะตะฝะธั
    'has_access_token': bool,    # ะััั ะปะธ access ัะพะบะตะฝ
    'has_refresh_token': bool,   # ะััั ะปะธ refresh ัะพะบะตะฝ
    'token_status': str          # ะกัะฐััั ัะพะบะตะฝะฐ ('valid', 'expired', 'missing')
}
```

**ะัะธะผะตั ะธัะฟะพะปัะทะพะฒะฐะฝะธั:**
```python
token_info = db.get_user_token_info(9197005)

print(f"ะััั ัะพะบะตะฝั: {token_info['has_tokens']}")
print(f"ะขะพะบะตะฝ ะธััะตะบ: {token_info['is_expired']}")
print(f"ะกัะฐััั: {token_info['token_status']}")
print(f"ะััะตะบะฐะตั: {token_info['expires_at']}")
```

#### `clear_user_tokens(vk_user_id: int) -> bool`
**ะะฐะทะฝะฐัะตะฝะธะต:** ะะพะปะฝะพัััั ะพัะธัะฐะตั ะฒัะต ัะพะบะตะฝั ะฟะพะปัะทะพะฒะฐัะตะปั ะธะท ะฑะฐะทั ะดะฐะฝะฝัั.

**ะะฐัะฐะผะตััั:**
- `vk_user_id` (int): VK ID ะฟะพะปัะทะพะฒะฐัะตะปั

**ะะพะทะฒัะฐัะฐะตั:** `bool` - True ะตัะปะธ ะพัะธััะบะฐ ััะฟะตัะฝะฐ

**ะงัะพ ะฟัะพะธััะพะดะธั ะฒะฝัััะธ:**
1. ะะพะธัะบ ะฟะพะปัะทะพะฒะฐัะตะปั ะฒ ัะฐะฑะปะธัะต `user_settings`
2. ะฃะดะฐะปะตะฝะธะต ะฒัะตั ะฟะพะปะตะน ัะฒัะทะฐะฝะฝัั ั ัะพะบะตะฝะฐะผะธ:
   - `encrypted_access_token`
   - `encrypted_refresh_token`
   - `refresh_token_hash`
   - `token_salt`
   - `token_iv`
   - `token_expires_at`
   - `token_updated_at`

**ะัะธะผะตั ะธัะฟะพะปัะทะพะฒะฐะฝะธั:**
```python
success = db.clear_user_tokens(9197005)

if success:
    print("โ ะัะต ัะพะบะตะฝั ะฟะพะปัะทะพะฒะฐัะตะปั ัะดะฐะปะตะฝั")
else:
    print("โ ะัะธะฑะบะฐ ัะดะฐะปะตะฝะธั ัะพะบะตะฝะพะฒ")
```

### ๐ง ะัััะพะตะฝะฝัะต ะผะตัะพะดั ัะธััะพะฒะฐะฝะธั

#### `encrypt_access_token(access_token: str) -> str`
**ะะฐะทะฝะฐัะตะฝะธะต:** ะจะธัััะตั access ัะพะบะตะฝ ั ะฟะพะผะพััั AES-256.

**ะะฐัะฐะผะตััั:**
- `access_token` (str): ะััะพะดะฝัะน access ัะพะบะตะฝ

**ะะพะทะฒัะฐัะฐะตั:** `str` - ะะฐัะธััะพะฒะฐะฝะฝัะน ัะพะบะตะฝ ะฒ base64 ัะพัะผะฐัะต

**ะัะธะผะตั ะธัะฟะพะปัะทะพะฒะฐะฝะธั:**
```python
encrypted = db.encrypt_access_token("vk1.a.test_token")
print(f"ะะฐัะธััะพะฒะฐะฝะฝัะน ัะพะบะตะฝ: {encrypted[:30]}...")
```

#### `decrypt_access_token(encrypted_token: str) -> str`
**ะะฐะทะฝะฐัะตะฝะธะต:** ะะฐััะธััะพะฒัะฒะฐะตั access ัะพะบะตะฝ.

**ะะฐัะฐะผะตััั:**
- `encrypted_token` (str): ะะฐัะธััะพะฒะฐะฝะฝัะน ัะพะบะตะฝ

**ะะพะทะฒัะฐัะฐะตั:** `str` - ะะฐััะธััะพะฒะฐะฝะฝัะน ัะพะบะตะฝ

**ะัะธะผะตั ะธัะฟะพะปัะทะพะฒะฐะฝะธั:**
```python
decrypted = db.decrypt_access_token(encrypted)
print(f"ะะฐััะธััะพะฒะฐะฝะฝัะน ัะพะบะตะฝ: {decrypted}")
```

#### `hash_refresh_token(refresh_token: str, salt: Optional[str] = None) -> Tuple[str, str]`
**ะะฐะทะฝะฐัะตะฝะธะต:** ะฅะตัะธััะตั refresh ัะพะบะตะฝ ั ัะพะปัั ะดะปั ะฑััััะพะน ะฟัะพะฒะตัะบะธ.

**ะะฐัะฐะผะตััั:**
- `refresh_token` (str): ะััะพะดะฝัะน refresh ัะพะบะตะฝ
- `salt` (Optional[str]): ะกะพะปั ะดะปั ัะตัะธัะพะฒะฐะฝะธั (ะตัะปะธ ะฝะต ัะบะฐะทะฐะฝะฐ, ะณะตะฝะตัะธััะตััั ะฐะฒัะพะผะฐัะธัะตัะบะธ)

**ะะพะทะฒัะฐัะฐะตั:** `Tuple[str, str]` - (ัะตั_ัะพะบะตะฝะฐ, ัะพะปั)

**ะัะธะผะตั ะธัะฟะพะปัะทะพะฒะฐะฝะธั:**
```python
token_hash, salt = db.hash_refresh_token("vk2.a.refresh_token")
print(f"ะฅะตั: {token_hash[:20]}...")
print(f"ะกะพะปั: {salt}")
```

#### `verify_refresh_token(refresh_token: str, token_hash: str, salt: str) -> bool`
**ะะฐะทะฝะฐัะตะฝะธะต:** ะัะพะฒะตััะตั refresh ัะพะบะตะฝ ะฟะพ ัะตัั.

**ะะฐัะฐะผะตััั:**
- `refresh_token` (str): ะขะพะบะตะฝ ะดะปั ะฟัะพะฒะตัะบะธ
- `token_hash` (str): ะกะพััะฐะฝะตะฝะฝัะน ัะตั
- `salt` (str): ะกะพะปั ะดะปั ัะตัะธัะพะฒะฐะฝะธั

**ะะพะทะฒัะฐัะฐะตั:** `bool` - True ะตัะปะธ ัะพะบะตะฝ ัะพะฒะฟะฐะดะฐะตั

**ะัะธะผะตั ะธัะฟะพะปัะทะพะฒะฐะฝะธั:**
```python
is_valid = db.verify_refresh_token("vk2.a.refresh_token", token_hash, salt)
print(f"ะขะพะบะตะฝ ะฒะฐะปะธะดะตะฝ: {is_valid}")
```

#### `generate_token_data(access_token: str, refresh_token: str, expires_in: int = 3600) -> Dict[str, Any]`
**ะะฐะทะฝะฐัะตะฝะธะต:** ะะตะฝะตัะธััะตั ะฒัะต ะดะฐะฝะฝัะต ะดะปั ััะฐะฝะตะฝะธั ัะพะบะตะฝะพะฒ.

**ะะฐัะฐะผะตััั:**
- `access_token` (str): Access ัะพะบะตะฝ
- `refresh_token` (str): Refresh ัะพะบะตะฝ
- `expires_in` (int): ะัะตะผั ะถะธะทะฝะธ ะฒ ัะตะบัะฝะดะฐั

**ะะพะทะฒัะฐัะฐะตั:** `Dict[str, Any]` - ะะพะปะฝัะน ัะปะพะฒะฐัั ะดะฐะฝะฝัั ะดะปั ัะพััะฐะฝะตะฝะธั

**ะกัััะบัััะฐ ะฒะพะทะฒัะฐัะฐะตะผะพะณะพ ัะปะพะฒะฐัั:**
```python
{
    'encrypted_access_token': str,    # ะะฐัะธััะพะฒะฐะฝะฝัะน access ัะพะบะตะฝ
    'encrypted_refresh_token': str,   # ะะฐัะธััะพะฒะฐะฝะฝัะน refresh ัะพะบะตะฝ
    'refresh_token_hash': str,        # ะฅะตั refresh ัะพะบะตะฝะฐ
    'token_salt': str,                # ะกะพะปั ะดะปั ัะตัะธัะพะฒะฐะฝะธั
    'token_iv': str,                  # IV ะดะปั ัะธััะพะฒะฐะฝะธั
    'token_expires_at': datetime,     # ะัะตะผั ะธััะตัะตะฝะธั
    'token_updated_at': datetime      # ะัะตะผั ะพะฑะฝะพะฒะปะตะฝะธั
}
```

**ะัะธะผะตั ะธัะฟะพะปัะทะพะฒะฐะฝะธั:**
```python
token_data = db.generate_token_data("access_token", "refresh_token", 3600)
print(f"ะกะณะตะฝะตัะธัะพะฒะฐะฝะพ {len(token_data)} ะฟะพะปะตะน ะดะปั ัะพััะฐะฝะตะฝะธั")
```

## ๐ ะกะธััะตะผะฐ ัะพะบะตะฝะพะฒ

### ะะฑะทะพั ัะธััะตะผั ัะพะบะตะฝะพะฒ

ะกะธััะตะผะฐ ัะพะบะตะฝะพะฒ ะฒ ะฟัะพะตะบัะต VKinder Bot ัะตะฐะปะธะทะพะฒะฐะฝะฐ ั ะธัะฟะพะปัะทะพะฒะฐะฝะธะตะผ **ะทะฐัะธััะพะฒะฐะฝะฝะพะณะพ ััะฐะฝะตะฝะธั** ะฒ ะฑะฐะทะต ะดะฐะฝะฝัั PostgreSQL. ะขะพะบะตะฝั ะฟะพะปัะทะพะฒะฐัะตะปะตะน ััะฐะฝัััั ะฒ ัะฐะฑะปะธัะต `user_settings` ั ะฟัะธะผะตะฝะตะฝะธะตะผ AES-ัะธััะพะฒะฐะฝะธั.

### ะขะธะฟั ัะพะบะตะฝะพะฒ

#### 1. Access Token (ะขะพะบะตะฝ ะดะพัััะฟะฐ)
- **ะะฐะทะฝะฐัะตะฝะธะต**: ะะปั ะฒัะฟะพะปะฝะตะฝะธั ะทะฐะฟัะพัะพะฒ ะบ VK API ะพั ะธะผะตะฝะธ ะฟะพะปัะทะพะฒะฐัะตะปั
- **ะฅัะฐะฝะตะฝะธะต**: ะะฐัะธััะพะฒะฐะฝ ะฒ ะฟะพะปะต `encrypted_access_token`
- **ะจะธััะพะฒะฐะฝะธะต**: AES-256 ัะตัะตะท ะฑะธะฑะปะธะพัะตะบั `cryptography.fernet`
- **ะัะตะผั ะถะธะทะฝะธ**: ะะฑััะฝะพ 1 ัะฐั (3600 ัะตะบัะฝะด)

#### 2. Refresh Token (ะขะพะบะตะฝ ะพะฑะฝะพะฒะปะตะฝะธั)
- **ะะฐะทะฝะฐัะตะฝะธะต**: ะะปั ะฟะพะปััะตะฝะธั ะฝะพะฒัั access ัะพะบะตะฝะพะฒ ะฑะตะท ะฟะพะฒัะพัะฝะพะน ะฐะฒัะพัะธะทะฐัะธะธ
- **ะฅัะฐะฝะตะฝะธะต**: ะะฐัะธััะพะฒะฐะฝ ะฒ ะฟะพะปะต `encrypted_refresh_token`
- **ะัะพะฒะตัะบะฐ**: ะฅะตั ััะฐะฝะธััั ะฒ `refresh_token_hash` ะดะปั ะฑััััะพะน ะฟัะพะฒะตัะบะธ
- **ะัะตะผั ะถะธะทะฝะธ**: ะะฑััะฝะพ 30 ะดะฝะตะน

### ะะพะดัะปะธ ัะฐะฑะพัั ั ัะพะบะตะฝะฐะผะธ

#### 1. ะัััะพะตะฝะฝัะต ะผะตัะพะดั ัะธััะพะฒะฐะฝะธั ะฒ `DatabaseInterface`

**ะะฐัะฟะพะปะพะถะตะฝะธะต:** `src/database/database_interface.py`

**ะัะฝะพะฒะฝัะต ะผะตัะพะดั ัะธััะพะฒะฐะฝะธั:**

```python
class DatabaseInterface:
    # === ะะะขะะะซ ะจะะคะะะะะะะฏ ะ ะะะจะะคะะะะะะะฏ ะขะะะะะะ ===
    
    def encrypt_access_token(self, access_token: str) -> str:
        """ะจะธััะพะฒะฐะฝะธะต access ัะพะบะตะฝะฐ"""
        
    def decrypt_access_token(self, encrypted_token: str) -> str:
        """ะะฐััะธััะพะฒะบะฐ access ัะพะบะตะฝะฐ"""
        
    def encrypt_refresh_token(self, refresh_token: str) -> str:
        """ะจะธััะพะฒะฐะฝะธะต refresh ัะพะบะตะฝะฐ"""
        
    def decrypt_refresh_token(self, encrypted_token: str) -> str:
        """ะะฐััะธััะพะฒะบะฐ refresh ัะพะบะตะฝะฐ"""
        
    def hash_refresh_token(self, refresh_token: str, salt: Optional[str] = None) -> Tuple[str, str]:
        """ะฅะตัะธัะพะฒะฐะฝะธะต refresh ัะพะบะตะฝะฐ ั ัะพะปัั"""
        
    def verify_refresh_token(self, refresh_token: str, token_hash: str, salt: str) -> bool:
        """ะัะพะฒะตัะบะฐ refresh ัะพะบะตะฝะฐ"""
        
    def generate_token_data(self, access_token: str, refresh_token: str, expires_in: int = 3600) -> Dict[str, Any]:
        """ะะตะฝะตัะฐัะธั ะฒัะตั ะดะฐะฝะฝัั ะดะปั ััะฐะฝะตะฝะธั ัะพะบะตะฝะพะฒ"""
        
    def is_token_expired(self, expires_at: datetime) -> bool:
        """ะัะพะฒะตัะบะฐ ะธััะตัะตะฝะธั ัะพะบะตะฝะฐ"""
        
    def get_token_expiry_time(self, expires_in: int) -> datetime:
        """ะะพะปััะตะฝะธะต ะฒัะตะผะตะฝะธ ะธััะตัะตะฝะธั ัะพะบะตะฝะฐ"""
```

**ะัะตะธะผััะตััะฒะฐ ะฒัััะพะตะฝะฝะพะณะพ ัะธััะพะฒะฐะฝะธั:**
- **ะะฝัะตะณัะฐัะธั**: ะะพะปะฝะฐั ะธะฝัะตะณัะฐัะธั ั ะฑะฐะทะพะน ะดะฐะฝะฝัั
- **ะัะพะธะทะฒะพะดะธัะตะปัะฝะพััั**: ะะตั ะดะพะฟะพะปะฝะธัะตะปัะฝัั ะธะผะฟะพััะพะฒ ะธ ะธะฝะธัะธะฐะปะธะทะฐัะธะน
- **ะะตะทะพะฟะฐัะฝะพััั**: ะะดะธะฝะฐั ัะธััะตะผะฐ ัะฟัะฐะฒะปะตะฝะธั ะบะปััะฐะผะธ
- **ะัะพััะพัะฐ**: ะัะต ะพะฟะตัะฐัะธะธ ั ัะพะบะตะฝะฐะผะธ ะฒ ะพะดะฝะพะผ ะผะตััะต
- **ะะฐะดะตะถะฝะพััั**: ะะฒัะพะผะฐัะธัะตัะบะฐั ะพะฑัะฐะฑะพัะบะฐ ะพัะธะฑะพะบ

#### 2. `DatabaseInterface` - ะผะตัะพะดั ะดะปั ัะฐะฑะพัั ั ัะพะบะตะฝะฐะผะธ

```python
class DatabaseInterface:
    def save_user_tokens(self, vk_user_id: int, access_token: str, refresh_token: str, expires_in: int = 3600) -> bool:
        """ะกะพััะฐะฝะตะฝะธะต ะทะฐัะธััะพะฒะฐะฝะฝัั ัะพะบะตะฝะพะฒ ะฟะพะปัะทะพะฒะฐัะตะปั (ะธัะฟะพะปัะทัะตั ะฒัััะพะตะฝะฝะพะต ัะธััะพะฒะฐะฝะธะต)"""
        
    def get_user_access_token(self, vk_user_id: int) -> Optional[str]:
        """ะะพะปััะตะฝะธะต ัะฐััะธััะพะฒะฐะฝะฝะพะณะพ access ัะพะบะตะฝะฐ (ะธัะฟะพะปัะทัะตั ะฒัััะพะตะฝะฝะพะต ะดะตัะธััะพะฒะฐะฝะธะต)"""
        
    def get_user_refresh_token_decrypted(self, vk_user_id: int) -> Optional[str]:
        """ะะพะปััะตะฝะธะต ัะฐััะธััะพะฒะฐะฝะฝะพะณะพ refresh ัะพะบะตะฝะฐ (ะธัะฟะพะปัะทัะตั ะฒัััะพะตะฝะฝะพะต ะดะตัะธััะพะฒะฐะฝะธะต)"""
        
    def verify_user_refresh_token(self, vk_user_id: int, refresh_token: str) -> bool:
        """ะัะพะฒะตัะบะฐ refresh ัะพะบะตะฝะฐ (ะธัะฟะพะปัะทัะตั ะฒัััะพะตะฝะฝัั ะฒะตัะธัะธะบะฐัะธั)"""
        
    def is_user_token_expired(self, vk_user_id: int) -> bool:
        """ะัะพะฒะตัะบะฐ ะธััะตัะตะฝะธั ัะพะบะตะฝะฐ (ะธัะฟะพะปัะทัะตั ะฒัััะพะตะฝะฝัั ะฟัะพะฒะตัะบั)"""
        
    def clear_user_tokens(self, vk_user_id: int) -> bool:
        """ะัะธััะบะฐ ัะพะบะตะฝะพะฒ ะฟะพะปัะทะพะฒะฐัะตะปั"""
        
    def get_user_token_info(self, vk_user_id: int) -> dict:
        """ะะพะปััะตะฝะธะต ะธะฝัะพัะผะฐัะธะธ ะพ ัะพะบะตะฝะฐั ะฟะพะปัะทะพะฒะฐัะตะปั"""
        
    def update_user_tokens(self, vk_user_id: int, access_token: Optional[str] = None, 
                          refresh_token: Optional[str] = None, expires_in: Optional[int] = None) -> bool:
        """ะะฑะฝะพะฒะปะตะฝะธะต ัะพะบะตะฝะพะฒ ะฟะพะปัะทะพะฒะฐัะตะปั (ะธัะฟะพะปัะทัะตั ะฒัััะพะตะฝะฝะพะต ัะธััะพะฒะฐะฝะธะต)"""
```

**ะะปััะตะฒัะต ะพัะพะฑะตะฝะฝะพััะธ:**
- **ะะฒัะพะผะฐัะธัะตัะบะพะต ัะธััะพะฒะฐะฝะธะต**: ะัะต ัะพะบะตะฝั ะฐะฒัะพะผะฐัะธัะตัะบะธ ัะธััััััั ะฟัะธ ัะพััะฐะฝะตะฝะธะธ
- **ะะฒัะพะผะฐัะธัะตัะบะพะต ะดะตัะธััะพะฒะฐะฝะธะต**: ะขะพะบะตะฝั ะฐะฒัะพะผะฐัะธัะตัะบะธ ัะฐััะธััะพะฒัะฒะฐัััั ะฟัะธ ะฟะพะปััะตะฝะธะธ
- **ะัััะพะตะฝะฝะฐั ะฑะตะทะพะฟะฐัะฝะพััั**: ะัะต ะบัะธะฟัะพะณัะฐัะธัะตัะบะธะต ะพะฟะตัะฐัะธะธ ะฒัะฟะพะปะฝััััั ะฒะฝัััะธ ะธะฝัะตััะตะนัะฐ
- **ะะดะธะฝัะน ะธะฝัะตััะตะนั**: ะะดะธะฝ ะบะปะฐัั ะดะปั ะฒัะตั ะพะฟะตัะฐัะธะน ั ัะพะบะตะฝะฐะผะธ


### ะัะพัะตัั ัะฐะฑะพัั ั ัะพะบะตะฝะฐะผะธ

#### ะกะพััะฐะฝะตะฝะธะต ัะพะบะตะฝะพะฒ
```python
# ะัะธะผะตั ัะพััะฐะฝะตะฝะธั ัะพะบะตะฝะพะฒ (ะฐะฒัะพะผะฐัะธัะตัะบะพะต ัะธััะพะฒะฐะฝะธะต)
db_interface = DatabaseInterface()

success = db_interface.save_user_tokens(
    vk_user_id=9197005,
    access_token="vk1.a.abc123...",
    refresh_token="vk2.a.def456...",
    expires_in=3600
)

if success:
    print("โ ะขะพะบะตะฝั ัะพััะฐะฝะตะฝั ะธ ะทะฐัะธััะพะฒะฐะฝั ะฐะฒัะพะผะฐัะธัะตัะบะธ")
else:
    print("โ ะัะธะฑะบะฐ ัะพััะฐะฝะตะฝะธั ัะพะบะตะฝะพะฒ")
```

#### ะะพะปััะตะฝะธะต ัะพะบะตะฝะพะฒ
```python
# ะะพะปััะตะฝะธะต access ัะพะบะตะฝะฐ (ะฐะฒัะพะผะฐัะธัะตัะบะพะต ะดะตัะธััะพะฒะฐะฝะธะต)
access_token = db_interface.get_user_access_token(9197005)

if access_token:
    print(f"โ Access ัะพะบะตะฝ ะฟะพะปััะตะฝ ะธ ัะฐััะธััะพะฒะฐะฝ: {access_token[:20]}...")
else:
    print("โ ะขะพะบะตะฝ ะฝะต ะฝะฐะนะดะตะฝ ะธะปะธ ะธััะตะบ")
```

#### ะะฑะฝะพะฒะปะตะฝะธะต ัะพะบะตะฝะพะฒ
```python
# ะะฑะฝะพะฒะปะตะฝะธะต ัะพะบะตะฝะฐ ัะตัะตะท ะฒัััะพะตะฝะฝัะต ะผะตัะพะดั DatabaseInterface
success = db.update_user_tokens(
    vk_user_id=9197005,
    access_token="vk1.a.new_access_token...",
    refresh_token="vk2.a.new_refresh_token...",
    expires_in=3600
)

if success:
    print("โ ะขะพะบะตะฝั ะพะฑะฝะพะฒะปะตะฝั ะธ ะทะฐัะธััะพะฒะฐะฝั")
else:
    print("โ ะะต ัะดะฐะปะพัั ะพะฑะฝะพะฒะธัั ัะพะบะตะฝั")
```

#### ะััะผะพะต ะธัะฟะพะปัะทะพะฒะฐะฝะธะต ะผะตัะพะดะพะฒ ัะธััะพะฒะฐะฝะธั
```python
# ะััะผะพะต ะธัะฟะพะปัะทะพะฒะฐะฝะธะต ะฒัััะพะตะฝะฝัั ะผะตัะพะดะพะฒ ัะธััะพะฒะฐะฝะธั
db_interface = DatabaseInterface()

# ะจะธััะพะฒะฐะฝะธะต ัะพะบะตะฝะฐ
encrypted_token = db_interface.encrypt_access_token("vk1.a.test_token")

# ะะตัะธััะพะฒะฐะฝะธะต ัะพะบะตะฝะฐ
decrypted_token = db_interface.decrypt_access_token(encrypted_token)

# ะฅะตัะธัะพะฒะฐะฝะธะต refresh ัะพะบะตะฝะฐ
token_hash, salt = db_interface.hash_refresh_token("vk1.a.refresh_token")

# ะัะพะฒะตัะบะฐ refresh ัะพะบะตะฝะฐ
is_valid = db_interface.verify_refresh_token("vk1.a.refresh_token", token_hash, salt)

# ะะตะฝะตัะฐัะธั ะฟะพะปะฝัั ะดะฐะฝะฝัั ัะพะบะตะฝะพะฒ
token_data = db_interface.generate_token_data("access_token", "refresh_token", 3600)
```

### ะะตะทะพะฟะฐัะฝะพััั ัะพะบะตะฝะพะฒ

#### ๐ ะััะธัะตะบัััะฐ ะฑะตะทะพะฟะฐัะฝะพััะธ

ะกะธััะตะผะฐ ะฑะตะทะพะฟะฐัะฝะพััะธ ัะพะบะตะฝะพะฒ ะฟะพัััะพะตะฝะฐ ะฝะฐ ะผะฝะพะณะพััะพะฒะฝะตะฒะพะน ะทะฐัะธัะต ั ะธัะฟะพะปัะทะพะฒะฐะฝะธะตะผ ัะพะฒัะตะผะตะฝะฝัั ะบัะธะฟัะพะณัะฐัะธัะตัะบะธั ะฐะปะณะพัะธัะผะพะฒ, **ะฟะพะปะฝะพัััั ะธะฝัะตะณัะธัะพะฒะฐะฝะฝัั ะฒ DatabaseInterface**:

```
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ                    ะขะพะบะตะฝ ะฑะตะทะพะฟะฐัะฝะพััะธ                      โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโค
โ  DatabaseInterface (ะฒัััะพะตะฝะฝะพะต ัะธััะพะฒะฐะฝะธะต)                  โ
โ  โโ encrypt_access_token()     - AES-256 ัะธััะพะฒะฐะฝะธะต        โ
โ  โโ decrypt_access_token()     - AES-256 ะดะตัะธััะพะฒะฐะฝะธะต      โ
โ  โโ hash_refresh_token()        - PBKDF2 + SHA-256         โ
โ  โโ verify_refresh_token()      - ะัะพะฒะตัะบะฐ ัะตัะฐ            โ
โ  โโ generate_token_data()       - ะะพะปะฝะฐั ะณะตะฝะตัะฐัะธั ะดะฐะฝะฝัั  โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโค
โ  ๐ ะะตะฝะตัะฐัะธั ะบะปััะตะน (ะฒัััะพะตะฝะฝะฐั)                          โ
โ  โโโ PBKDF2 ั ัะพะปัั (100,000 ะธัะตัะฐัะธะน)                     โ
โ  โโโ SHA-256 ะดะปั ัะตัะธัะพะฒะฐะฝะธั                                โ
โ  โโโ ะกะปััะฐะนะฝะฐั ะณะตะฝะตัะฐัะธั IV ะธ ัะพะปะธ                         โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโค
โ  ๐ก๏ธ ะจะธััะพะฒะฐะฝะธะต ัะพะบะตะฝะพะฒ (ะฒัััะพะตะฝะฝะพะต)                        โ
โ  โโโ AES-256-CBC ะดะปั access token                          โ
โ  โโโ AES-256-CBC ะดะปั refresh token                         โ
โ  โโโ ะฃะฝะธะบะฐะปัะฝัะต IV ะดะปั ะบะฐะถะดะพะณะพ ัะพะบะตะฝะฐ                      โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโค
โ  ๐๏ธ ะฅัะฐะฝะตะฝะธะต ะฒ ะะ                                          โ
โ  โโโ ะะฐัะธััะพะฒะฐะฝะฝัะต ัะพะบะตะฝั ะฒ user_settings                   โ
โ  โโโ ะฅะตัะธ refresh ัะพะบะตะฝะพะฒ ะดะปั ะฑััััะพะน ะฟัะพะฒะตัะบะธ             โ
โ  โโโ ะะตัะฐะดะฐะฝะฝัะต (ัะพะปั, IV, ะฒัะตะผั ะธััะตัะตะฝะธั)               โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโค
โ  ๐ ะะฐะปะธะดะฐัะธั ะธ ะฟัะพะฒะตัะบะฐ (ะฒัััะพะตะฝะฝะฐั)                      โ
โ  โโโ ะัะพะฒะตัะบะฐ ะฒัะตะผะตะฝะธ ะธััะตัะตะฝะธั                            โ
โ  โโโ ะะตัะธัะธะบะฐัะธั ัะตัะตะน refresh ัะพะบะตะฝะพะฒ                     โ
โ  โโโ ะะฒัะพะผะฐัะธัะตัะบะพะต ะพะฑะฝะพะฒะปะตะฝะธะต ะฟัะธ ะฝะตะพะฑัะพะดะธะผะพััะธ          โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
```

**ะะปััะตะฒัะต ะฟัะตะธะผััะตััะฒะฐ ะฒัััะพะตะฝะฝะพะณะพ ัะธััะพะฒะฐะฝะธั:**
- **ะะดะธะฝะฐั ัะพัะบะฐ ะฒัะพะดะฐ**: ะัะต ะบัะธะฟัะพะณัะฐัะธัะตัะบะธะต ะพะฟะตัะฐัะธะธ ะฒ ะพะดะฝะพะผ ะบะปะฐััะต
- **ะะฒัะพะผะฐัะธัะตัะบะฐั ะฑะตะทะพะฟะฐัะฝะพััั**: ะจะธััะพะฒะฐะฝะธะต/ะดะตัะธััะพะฒะฐะฝะธะต ะฟัะพะธััะพะดะธั ะฐะฒัะพะผะฐัะธัะตัะบะธ
- **ะฆะตะฝััะฐะปะธะทะพะฒะฐะฝะฝะพะต ัะฟัะฐะฒะปะตะฝะธะต ะบะปััะฐะผะธ**: ะะดะธะฝ ะธััะพัะฝะธะบ ะบะปััะตะน ัะธััะพะฒะฐะฝะธั
- **ะะฟัะธะผะธะทะธัะพะฒะฐะฝะฝะฐั ะฟัะพะธะทะฒะพะดะธัะตะปัะฝะพััั**: ะะตั ะดะพะฟะพะปะฝะธัะตะปัะฝัั ะธะผะฟะพััะพะฒ ะธ ะธะฝะธัะธะฐะปะธะทะฐัะธะน
- **ะฃะฟัะพัะตะฝะฝะฐั ะฐััะธัะตะบัััะฐ**: ะะตะฝััะต ะทะฐะฒะธัะธะผะพััะตะน ะธ ัะปะพะถะฝะพััะธ

#### ๐ ะะตัะฐะปะธ ัะธััะพะฒะฐะฝะธั

##### 1. ะะตะฝะตัะฐัะธั ะบะปััะตะน ัะธััะพะฒะฐะฝะธั (ะฒัััะพะตะฝะฝะฐั ะฒ DatabaseInterface)
```python
# ะัััะพะตะฝะฝัะน ะผะตัะพะด DatabaseInterface._get_encryption_key()
def _get_encryption_key(self) -> str:
    """
    ะะพะปััะตะฝะธะต ะบะปััะฐ ัะธััะพะฒะฐะฝะธั ะธะท ะฟะตัะตะผะตะฝะฝัั ะพะบััะถะตะฝะธั
    ะะฒัะพะผะฐัะธัะตัะบะธ ะณะตะฝะตัะธััะตั ะบะปัั ะฝะฐ ะพัะฝะพะฒะต VK_APP_SECRET ะตัะปะธ ะฝะต ัะบะฐะทะฐะฝ ัะฟะตัะธะฐะปัะฝัะน
    """
    key = os.getenv('TOKEN_ENCRYPTION_KEY')
    if not key:
        # ะะตะฝะตัะธััะตะผ ะบะปัั ะฝะฐ ะพัะฝะพะฒะต VK_APP_SECRET ะตัะปะธ ะฝะตั ัะฟะตัะธะฐะปัะฝะพะณะพ ะบะปััะฐ
        app_secret = os.getenv('VK_APP_SECRET', 'default_secret')
        key = hashlib.sha256(app_secret.encode()).hexdigest()
        centralized_logger.warning("โ๏ธ ะัะฟะพะปัะทัะตััั ะฐะฒัะพะผะฐัะธัะตัะบะธ ัะณะตะฝะตัะธัะพะฒะฐะฝะฝัะน ะบะปัั ัะธััะพะฒะฐะฝะธั", user_id=0)
    return key

# ะัััะพะตะฝะฝัะน ะผะตัะพะด DatabaseInterface._create_cipher()
def _create_cipher(self) -> Fernet:
    """
    ะกะพะทะดะฐะฝะธะต ะพะฑัะตะบัะฐ ัะธััะพะฒะฐะฝะธั Fernet
    ะะฒัะพะผะฐัะธัะตัะบะธ ะฒัะทัะฒะฐะตััั ะฟัะธ ะธะฝะธัะธะฐะปะธะทะฐัะธะธ DatabaseInterface
    """
    try:
        # ะัะตะพะฑัะฐะทัะตะผ ะบะปัั ะฒ ัะพัะผะฐั Fernet
        key_bytes = self.encryption_key.encode()
        key_hash = hashlib.sha256(key_bytes).digest()
        fernet_key = base64.urlsafe_b64encode(key_hash)
        return Fernet(fernet_key)
    except Exception as e:
        centralized_logger.error(f"โ ะัะธะฑะบะฐ ัะพะทะดะฐะฝะธั cipher: {e}")
        raise
```

##### 2. ะจะธััะพะฒะฐะฝะธะต access token (ะฒัััะพะตะฝะฝะพะต ะฒ DatabaseInterface)
```python
# ะัััะพะตะฝะฝัะน ะผะตัะพะด DatabaseInterface.encrypt_access_token()
def encrypt_access_token(self, access_token: str) -> str:
    """
    ะจะธััะพะฒะฐะฝะธะต access ัะพะบะตะฝะฐ ั ะธัะฟะพะปัะทะพะฒะฐะฝะธะตะผ Fernet (AES-256)
    ะะฒัะพะผะฐัะธัะตัะบะธ ะฒัะทัะฒะฐะตััั ะฟัะธ ัะพััะฐะฝะตะฝะธะธ ัะพะบะตะฝะพะฒ
    
    ะะปะณะพัะธัะผ:
    1. ะะพะดะธัะพะฒะฐะฝะธะต ัะพะบะตะฝะฐ ะฒ UTF-8
    2. ะจะธััะพะฒะฐะฝะธะต ั ะธัะฟะพะปัะทะพะฒะฐะฝะธะตะผ Fernet (AES-256)
    3. ะะพะทะฒัะฐั ะทะฐัะธััะพะฒะฐะฝะฝะพะน ัััะพะบะธ
    """
    try:
        encrypted_token = self.cipher.encrypt(access_token.encode())
        return encrypted_token.decode()
    except Exception as e:
        centralized_logger.error(f"โ ะัะธะฑะบะฐ ัะธััะพะฒะฐะฝะธั access ัะพะบะตะฝะฐ: {e}")
        raise

# ะัััะพะตะฝะฝัะน ะผะตัะพะด DatabaseInterface.decrypt_access_token()
def decrypt_access_token(self, encrypted_token: str) -> str:
    """
    ะะฐััะธััะพะฒะบะฐ access ัะพะบะตะฝะฐ
    ะะฒัะพะผะฐัะธัะตัะบะธ ะฒัะทัะฒะฐะตััั ะฟัะธ ะฟะพะปััะตะฝะธะธ ัะพะบะตะฝะพะฒ
    """
    try:
        decrypted_token = self.cipher.decrypt(encrypted_token.encode())
        return decrypted_token.decode()
    except Exception as e:
        centralized_logger.error(f"โ ะัะธะฑะบะฐ ัะฐััะธััะพะฒะบะธ access ัะพะบะตะฝะฐ: {e}")
        raise
```

##### 3. ะฅะตัะธัะพะฒะฐะฝะธะต refresh token (ะฒัััะพะตะฝะฝะพะต ะฒ DatabaseInterface)
```python
# ะัััะพะตะฝะฝัะน ะผะตัะพะด DatabaseInterface.hash_refresh_token()
def hash_refresh_token(self, refresh_token: str, salt: Optional[str] = None) -> Tuple[str, str]:
    """
    ะฅะตัะธัะพะฒะฐะฝะธะต refresh ัะพะบะตะฝะฐ ั ัะพะปัั ั ะธัะฟะพะปัะทะพะฒะฐะฝะธะตะผ PBKDF2
    ะะฒัะพะผะฐัะธัะตัะบะธ ะฒัะทัะฒะฐะตััั ะฟัะธ ัะพััะฐะฝะตะฝะธะธ ัะพะบะตะฝะพะฒ
    
    ะะปะณะพัะธัะผ:
    1. ะะตะฝะตัะฐัะธั ัะปััะฐะนะฝะพะน ัะพะปะธ (ะตัะปะธ ะฝะต ัะบะฐะทะฐะฝะฐ)
    2. ะฅะตัะธัะพะฒะฐะฝะธะต ั PBKDF2 + SHA-256 (100,000 ะธัะตัะฐัะธะน)
    3. ะะพะทะฒัะฐั ัะตัะฐ ะธ ัะพะปะธ
    
    ะะฐะทะฝะฐัะตะฝะธะต:
    - ะััััะฐั ะฟัะพะฒะตัะบะฐ ะฑะตะท ัะฐััะธััะพะฒะบะธ
    - ะะฐัะธัะฐ ะพั ะฐัะฐะบ ะฟะพ ะฒัะตะผะตะฝะธ
    - ะััะพะบะฐั ััะพะนะบะพััั ะบ ะฑััััะพััั
    """
    try:
        if not salt:
            salt = secrets.token_hex(16)
        
        # ะัะฟะพะปัะทัะตะผ PBKDF2 ะดะปั ัะตัะธัะพะฒะฐะฝะธั
        token_hash = hashlib.pbkdf2_hmac(
            'sha256',
            refresh_token.encode(),
            salt.encode(),
            100000  # 100,000 ะธัะตัะฐัะธะน
        )
        return token_hash.hex(), salt
    except Exception as e:
        centralized_logger.error(f"โ ะัะธะฑะบะฐ ัะตัะธัะพะฒะฐะฝะธั refresh ัะพะบะตะฝะฐ: {e}")
        raise

# ะัััะพะตะฝะฝัะน ะผะตัะพะด DatabaseInterface.verify_refresh_token()
def verify_refresh_token(self, refresh_token: str, token_hash: str, salt: str) -> bool:
    """
    ะัะพะฒะตัะบะฐ refresh ัะพะบะตะฝะฐ ะฟะพ ัะตัั
    ะะฒัะพะผะฐัะธัะตัะบะธ ะฒัะทัะฒะฐะตััั ะฟัะธ ะฟัะพะฒะตัะบะต ัะพะบะตะฝะพะฒ
    """
    try:
        computed_hash, _ = self.hash_refresh_token(refresh_token, salt)
        return computed_hash == token_hash
    except Exception as e:
        centralized_logger.error(f"โ ะัะธะฑะบะฐ ะฟัะพะฒะตัะบะธ refresh ัะพะบะตะฝะฐ: {e}")
        return False
```

#### ๐๏ธ ะกัััะบัััะฐ ััะฐะฝะตะฝะธั ะฒ ะะ

##### ะขะฐะฑะปะธัะฐ `user_settings` - ะฟะพะปั ัะพะบะตะฝะพะฒ
```sql
-- ะะพะปั ะดะปั ะฑะตะทะพะฟะฐัะฝะพะณะพ ััะฐะฝะตะฝะธั ัะพะบะตะฝะพะฒ
CREATE TABLE user_settings (
    vk_user_id INTEGER PRIMARY KEY,
    
    -- ะะฐัะธััะพะฒะฐะฝะฝัะต ัะพะบะตะฝั
    encrypted_access_token TEXT,      -- AES-256 ะทะฐัะธััะพะฒะฐะฝะฝัะน access token
    encrypted_refresh_token TEXT,     -- AES-256 ะทะฐัะธััะพะฒะฐะฝะฝัะน refresh token
    
    -- ะะตัะฐะดะฐะฝะฝัะต ะฑะตะทะพะฟะฐัะฝะพััะธ
    refresh_token_hash VARCHAR(128),  -- SHA-256 ัะตั refresh token
    token_salt VARCHAR(64),          -- ะกะพะปั ะดะปั ะณะตะฝะตัะฐัะธะธ ะบะปััะฐ
    token_iv VARCHAR(32),             -- IV ะดะปั AES ัะธััะพะฒะฐะฝะธั
    
    -- ะัะตะผะตะฝะฝัะต ะผะตัะบะธ
    token_expires_at TIMESTAMP,      -- ะัะตะผั ะธััะตัะตะฝะธั access token
    token_updated_at TIMESTAMP,      -- ะัะตะผั ะฟะพัะปะตะดะฝะตะณะพ ะพะฑะฝะพะฒะปะตะฝะธั
    
    -- ะะพะฟะพะปะฝะธัะตะปัะฝัะต ะฟะพะปั...
);
```

##### ะัะธะผะตั ะดะฐะฝะฝัั ะฒ ะะ
```sql
-- ะัะธะผะตั ะทะฐะฟะธัะธ ะฒ user_settings
INSERT INTO user_settings VALUES (
    9197005,                                    -- vk_user_id
    'U2FsdGVkX1+vupppZksvRf5pq5g5XjFRlipRkwB0K1Y=',  -- encrypted_access_token
    'U2FsdGVkX1+vupppZksvRf5pq5g5XjFRlipRkwB0K2Z=',  -- encrypted_refresh_token
    'a1b2c3d4e5f6...',                          -- refresh_token_hash
    's0d1e2f3g4h5i6j7k8l9m0n1o2p3q4r5s6t7u8v9w0',  -- token_salt
    'x1y2z3a4b5c6d7e8f9g0h1i2j3k4l5m6n7o8p9q0',     -- token_iv
    '2024-01-01 15:30:00',                       -- token_expires_at
    '2024-01-01 14:30:00'                        -- token_updated_at
);
```

#### ๐ ะัะพัะตัั ะดะตัะธััะพะฒะฐะฝะธั ะธ ะฟัะพะฒะตัะบะธ

##### 1. ะะพะปััะตะฝะธะต access token
```python
def get_user_access_token(vk_user_id: int) -> Optional[str]:
    """
    ะะพะปััะตะฝะธะต ะธ ัะฐััะธััะพะฒะบะฐ access token
    
    ะัะพัะตัั:
    1. ะะทะฒะปะตัะตะฝะธะต ะทะฐัะธััะพะฒะฐะฝะฝัั ะดะฐะฝะฝัั ะธะท ะะ
    2. ะะพัััะฐะฝะพะฒะปะตะฝะธะต ะบะปััะฐ ัะธััะพะฒะฐะฝะธั
    3. ะะตัะธััะพะฒะฐะฝะธะต AES-256-CBC
    4. ะัะพะฒะตัะบะฐ ะฒัะตะผะตะฝะธ ะธััะตัะตะฝะธั
    """
    # ะะพะปััะตะฝะธะต ะดะฐะฝะฝัั ะธะท ะะ
    user_data = get_user_settings(vk_user_id)
    if not user_data:
        return None
    
    # ะัะพะฒะตัะบะฐ ะฒัะตะผะตะฝะธ ะธััะตัะตะฝะธั
    if is_token_expired(user_data['token_expires_at']):
        return None
    
    # ะะพัััะฐะฝะพะฒะปะตะฝะธะต ะบะปััะฐ
    key = generate_encryption_key(
        app_secret=VK_APP_SECRET,
        salt=user_data['token_salt'].encode('utf-8')
    )
    
    # ะะตัะธััะพะฒะฐะฝะธะต
    decrypted_token = decrypt_access_token(
        encrypted_token=user_data['encrypted_access_token'],
        key=key,
        iv=user_data['token_iv'].encode('utf-8')
    )
    
    return decrypted_token
```

##### 2. ะัะพะฒะตัะบะฐ refresh token
```python
def verify_user_refresh_token(vk_user_id: int, refresh_token: str) -> bool:
    """
    ะัะพะฒะตัะบะฐ refresh token ะฑะตะท ัะฐััะธััะพะฒะบะธ
    
    ะัะพัะตัั:
    1. ะะพะปััะตะฝะธะต ัะตัะฐ ะธ ัะพะปะธ ะธะท ะะ
    2. ะฅะตัะธัะพะฒะฐะฝะธะต ะฟัะตะดะพััะฐะฒะปะตะฝะฝะพะณะพ ัะพะบะตะฝะฐ
    3. ะกัะฐะฒะฝะตะฝะธะต ัะตัะตะน
    """
    user_data = get_user_settings(vk_user_id)
    if not user_data:
        return False
    
    # ะฅะตัะธัะพะฒะฐะฝะธะต ะฟัะตะดะพััะฐะฒะปะตะฝะฝะพะณะพ ัะพะบะตะฝะฐ
    provided_hash = hash_refresh_token(
        token=refresh_token,
        salt=user_data['token_salt']
    )
    
    # ะกัะฐะฒะฝะตะฝะธะต ั ัะพััะฐะฝะตะฝะฝัะผ ัะตัะตะผ
    return provided_hash == user_data['refresh_token_hash']
```

#### ๐ก๏ธ ะะพะฟะพะปะฝะธัะตะปัะฝัะต ะผะตัั ะฑะตะทะพะฟะฐัะฝะพััะธ

##### 1. ะะพัะฐัะธั ะบะปััะตะน
```python
def rotate_encryption_key():
    """
    ะะพัะฐัะธั ะบะปััะฐ ัะธััะพะฒะฐะฝะธั ะดะปั ะฟะพะฒััะตะฝะธั ะฑะตะทะพะฟะฐัะฝะพััะธ
    
    ะัะพัะตัั:
    1. ะะตะฝะตัะฐัะธั ะฝะพะฒะพะณะพ ะบะปััะฐ
    2. ะะตัะตัะธััะพะฒะฐะฝะธะต ะฒัะตั ัะพะบะตะฝะพะฒ
    3. ะะฑะฝะพะฒะปะตะฝะธะต ะผะตัะฐะดะฐะฝะฝัั
    """
    new_key = generate_new_encryption_key()
    
    # ะะตัะตัะธััะพะฒะฐะฝะธะต ะฒัะตั ัะพะบะตะฝะพะฒ
    for user_id in get_all_user_ids():
        reencrypt_user_tokens(user_id, new_key)
    
    # ะะฑะฝะพะฒะปะตะฝะธะต ัะธััะตะผะฝะพะณะพ ะบะปััะฐ
    update_system_encryption_key(new_key)
```

##### 2. ะัะดะธั ะฑะตะทะพะฟะฐัะฝะพััะธ
```python
def audit_token_security():
    """
    ะัะดะธั ะฑะตะทะพะฟะฐัะฝะพััะธ ัะพะบะตะฝะพะฒ
    
    ะัะพะฒะตัะบะธ:
    1. ะัะตะผั ะธััะตัะตะฝะธั ัะพะบะตะฝะพะฒ
    2. ะฆะตะปะพััะฝะพััั ะทะฐัะธััะพะฒะฐะฝะฝัั ะดะฐะฝะฝัั
    3. ะกะพะพัะฒะตัััะฒะธะต ัะตัะตะน refresh ัะพะบะตะฝะพะฒ
    4. ะะพะดะพะทัะธัะตะปัะฝะฐั ะฐะบัะธะฒะฝะพััั
    """
    security_report = {
        'expired_tokens': [],
        'corrupted_tokens': [],
        'suspicious_activity': [],
        'security_score': 0
    }
    
    # ะัะพะฒะตัะบะฐ ะฒัะตั ัะพะบะตะฝะพะฒ
    for user_id in get_all_user_ids():
        token_info = get_user_token_info(user_id)
        
        # ะัะพะฒะตัะบะฐ ะฒัะตะผะตะฝะธ ะธััะตัะตะฝะธั
        if is_token_expired(token_info['expires_at']):
            security_report['expired_tokens'].append(user_id)
        
        # ะัะพะฒะตัะบะฐ ัะตะปะพััะฝะพััะธ
        if not verify_token_integrity(user_id):
            security_report['corrupted_tokens'].append(user_id)
    
    return security_report
```

##### 3. ะะพะฝะธัะพัะธะฝะณ ะฑะตะทะพะฟะฐัะฝะพััะธ
```python
def monitor_token_security():
    """
    ะะพะฝะธัะพัะธะฝะณ ะฑะตะทะพะฟะฐัะฝะพััะธ ัะพะบะตะฝะพะฒ ะฒ ัะตะฐะปัะฝะพะผ ะฒัะตะผะตะฝะธ
    
    ะััะปะตะถะธะฒะฐะฝะธะต:
    1. ะะพะฟััะบะธ ะดะพัััะฟะฐ ะบ ะธััะตะบัะธะผ ัะพะบะตะฝะฐะผ
    2. ะะตัะดะฐัะฝัะต ะฟะพะฟััะบะธ ะดะตัะธััะพะฒะฐะฝะธั
    3. ะะพะดะพะทัะธัะตะปัะฝัะต ะฟะฐััะตัะฝั ะธัะฟะพะปัะทะพะฒะฐะฝะธั
    4. ะะฝะพะผะฐะปัะฝะฐั ะฐะบัะธะฒะฝะพััั
    """
    security_events = []
    
    # ะะพะณะธัะพะฒะฐะฝะธะต ะฟะพะฟััะพะบ ะดะพัััะฟะฐ
    def log_token_access(user_id: int, success: bool, error: str = None):
        event = {
            'timestamp': datetime.now(),
            'user_id': user_id,
            'success': success,
            'error': error,
            'ip_address': get_client_ip(),
            'user_agent': get_user_agent()
        }
        security_events.append(event)
        
        # ะะปะตัั ะฟัะธ ะฟะพะดะพะทัะธัะตะปัะฝะพะน ะฐะบัะธะฒะฝะพััะธ
        if not success and error:
            send_security_alert(event)
```

#### ๐ ะะตััะธะบะธ ะฑะตะทะพะฟะฐัะฝะพััะธ

##### ะกัะฐัะธััะธะบะฐ ะฑะตะทะพะฟะฐัะฝะพััะธ ัะพะบะตะฝะพะฒ
```python
def get_token_security_metrics() -> dict:
    """
    ะะพะปััะตะฝะธะต ะผะตััะธะบ ะฑะตะทะพะฟะฐัะฝะพััะธ ัะพะบะตะฝะพะฒ
    
    ะะตััะธะบะธ:
    1. ะะพะปะธัะตััะฒะพ ะฐะบัะธะฒะฝัั ัะพะบะตะฝะพะฒ
    2. ะัะพัะตะฝั ะธััะตะบัะธั ัะพะบะตะฝะพะฒ
    3. ะงะฐััะพัะฐ ะพะฑะฝะพะฒะปะตะฝะธะน ัะพะบะตะฝะพะฒ
    4. ะะพะปะธัะตััะฒะพ ะพัะธะฑะพะบ ะดะตัะธััะพะฒะฐะฝะธั
    5. ะัะตะผั ะพัะบะปะธะบะฐ ัะธััะตะผั ะฑะตะทะพะฟะฐัะฝะพััะธ
    """
    return {
        'total_tokens': count_total_tokens(),
        'active_tokens': count_active_tokens(),
        'expired_tokens': count_expired_tokens(),
        'refresh_rate': calculate_refresh_rate(),
        'decryption_errors': count_decryption_errors(),
        'avg_response_time': calculate_avg_response_time(),
        'security_score': calculate_security_score()
    }
```

#### ๐จ ะะฑัะฐะฑะพัะบะฐ ะธะฝัะธะดะตะฝัะพะฒ ะฑะตะทะพะฟะฐัะฝะพััะธ

##### ะัะพัะตะดััั ะฟัะธ ะบะพะผะฟัะพะผะตัะฐัะธะธ
```python
def handle_security_breach(user_id: int, breach_type: str):
    """
    ะะฑัะฐะฑะพัะบะฐ ะธะฝัะธะดะตะฝัะพะฒ ะฑะตะทะพะฟะฐัะฝะพััะธ
    
    ะะตะนััะฒะธั:
    1. ะะตะผะตะดะปะตะฝะฝะฐั ะฑะปะพะบะธัะพะฒะบะฐ ัะพะบะตะฝะพะฒ
    2. ะฃะฒะตะดะพะผะปะตะฝะธะต ะฟะพะปัะทะพะฒะฐัะตะปั
    3. ะะพะณะธัะพะฒะฐะฝะธะต ะธะฝัะธะดะตะฝัะฐ
    4. ะะฝะธัะธะฐัะธั ะฟะพะฒัะพัะฝะพะน ะฐะฒัะพัะธะทะฐัะธะธ
    """
    # ะะปะพะบะธัะพะฒะบะฐ ัะพะบะตะฝะพะฒ
    block_user_tokens(user_id)
    
    # ะะพะณะธัะพะฒะฐะฝะธะต ะธะฝัะธะดะตะฝัะฐ
    log_security_incident({
        'user_id': user_id,
        'breach_type': breach_type,
        'timestamp': datetime.now(),
        'action_taken': 'tokens_blocked'
    })
    
    # ะฃะฒะตะดะพะผะปะตะฝะธะต ะฟะพะปัะทะพะฒะฐัะตะปั
    send_security_notification(user_id, breach_type)
    
    # ะะฝะธัะธะฐัะธั ะฟะพะฒัะพัะฝะพะน ะฐะฒัะพัะธะทะฐัะธะธ
    initiate_reauth_process(user_id)
```

#### โ ะกะพะพัะฒะตัััะฒะธะต ััะฐะฝะดะฐััะฐะผ ะฑะตะทะพะฟะฐัะฝะพััะธ

##### ะกะพะพัะฒะตัััะฒะธะต ััะตะฑะพะฒะฐะฝะธัะผ
- **OWASP Top 10** - ะทะฐัะธัะฐ ะพั ะพัะฝะพะฒะฝัั ััะทะฒะธะผะพััะตะน
- **PCI DSS** - ััะฐะฝะดะฐััั ะฑะตะทะพะฟะฐัะฝะพััะธ ะดะฐะฝะฝัั
- **GDPR** - ัะพะพัะฒะตัััะฒะธะต ะตะฒัะพะฟะตะนัะบะพะผั ะทะฐะบะพะฝะพะดะฐัะตะปัััะฒั
- **ISO 27001** - ััะฐะฝะดะฐััั ะธะฝัะพัะผะฐัะธะพะฝะฝะพะน ะฑะตะทะพะฟะฐัะฝะพััะธ

##### ะกะตััะธัะธะบะฐัะธั ะฐะปะณะพัะธัะผะพะฒ
- **AES-256** - ัะตััะธัะธัะธัะพะฒะฐะฝ NIST
- **PBKDF2** - ัะตะบะพะผะตะฝะดะพะฒะฐะฝ RFC 2898
- **SHA-256** - ัะตััะธัะธัะธัะพะฒะฐะฝ NIST FIPS 180-4
- **HMAC** - ัะตะบะพะผะตะฝะดะพะฒะฐะฝ RFC 2104

#### ะจะธััะพะฒะฐะฝะธะต
- **ะะปะณะพัะธัะผ**: AES-256 ัะตัะตะท `cryptography.fernet`
- **ะะปัั**: ะะตะฝะตัะธััะตััั ะธะท `VK_APP_SECRET` ะธะปะธ ะฑะตัะตััั ะธะท `TOKEN_ENCRYPTION_KEY`
- **IV**: ะฃะฝะธะบะฐะปัะฝัะน ะดะปั ะบะฐะถะดะพะณะพ ัะพะบะตะฝะฐ
- **ะกะพะปั**: ะฃะฝะธะบะฐะปัะฝะฐั ะดะปั ะบะฐะถะดะพะณะพ refresh ัะพะบะตะฝะฐ

#### ะฅะตัะธัะพะฒะฐะฝะธะต
- **ะะปะณะพัะธัะผ**: SHA-256 ั ัะพะปัั
- **ะะฐะทะฝะฐัะตะฝะธะต**: ะััััะฐั ะฟัะพะฒะตัะบะฐ refresh ัะพะบะตะฝะพะฒ ะฑะตะท ัะฐััะธััะพะฒะบะธ
- **ะกะพะปั**: 32-ัะธะผะฒะพะปัะฝะฐั ัะปััะฐะนะฝะฐั ัััะพะบะฐ

#### ะะฐะปะธะดะฐัะธั
```python
# ะัะพะฒะตัะบะฐ ะฒะฐะปะธะดะฝะพััะธ ัะพะบะตะฝะฐ
is_valid = user_token_manager.is_user_token_valid(9197005)

if is_valid:
    print("โ ะขะพะบะตะฝ ะดะตะนััะฒะธัะตะปะตะฝ")
else:
    print("โ ะขะพะบะตะฝ ะธััะตะบ ะธะปะธ ะฝะตะดะตะนััะฒะธัะตะปะตะฝ")
```

### Fallback ะปะพะณะธะบะฐ

ะกะธััะตะผะฐ ะธัะฟะพะปัะทัะตั ะผะฝะพะณะพััะพะฒะฝะตะฒัั fallback ะปะพะณะธะบั:

1. **ะะฐะทะฐ ะดะฐะฝะฝัั** - ะพัะฝะพะฒะฝะพะน ะธััะพัะฝะธะบ ัะพะบะตะฝะพะฒ
2. **ะคะฐะนะป .env** - ัะตะทะตัะฒะฝัะน ะธััะพัะฝะธะบ
3. **ะะฑะฝะพะฒะปะตะฝะธะต ัะตัะตะท refresh token** - ะฐะฒัะพะผะฐัะธัะตัะบะพะต ะพะฑะฝะพะฒะปะตะฝะธะต
4. **ะะพะฒัะพัะฝะฐั ะฐะฒัะพัะธะทะฐัะธั** - ะตัะปะธ ะฒัะต ะพััะฐะปัะฝะพะต ะฝะต ัะฐะฑะพัะฐะตั

```python
# ะัะธะผะตั fallback ะปะพะณะธะบะธ
def get_user_token_with_fallback(vk_user_id: int) -> Optional[str]:
    # 1. ะัะพะฑัะตะผ ะะ
    token = db_interface.get_user_access_token(vk_user_id)
    if token:
        return token
    
    # 2. ะัะพะฑัะตะผ .env
    env_token = os.getenv('VK_USER_TOKEN')
    if env_token and is_token_valid(env_token):
        return env_token
    
    # 3. ะัะพะฑัะตะผ ะพะฑะฝะพะฒะธัั ัะตัะตะท refresh
    new_token = user_token_manager.refresh_user_token(vk_user_id)
    if new_token:
        return new_token
    
    # 4. ะขัะตะฑัะตะผ ะฟะพะฒัะพัะฝัั ะฐะฒัะพัะธะทะฐัะธั
    return None
```

## ๐ ะกะธััะตะผะฐ ะปะพะณะธัะพะฒะฐะฝะธั

### ะะฑะทะพั
VKinder Bot ะธัะฟะพะปัะทัะตั ะผะฝะพะณะพััะพะฒะฝะตะฒัั ัะธััะตะผั ะปะพะณะธัะพะฒะฐะฝะธั ั ะฟะพะดะดะตัะถะบะพะน ัะฐะนะปะพะฒะพะณะพ ะปะพะณะธัะพะฒะฐะฝะธั ะธ ะทะฐะฟะธัะธ ะฒ ะฑะฐะทั ะดะฐะฝะฝัั. ะกะธััะตะผะฐ ะพะฑะตัะฟะตัะธะฒะฐะตั ะดะตัะฐะปัะฝัั ััะฐััะธัะพะฒะบั ะฒัะตั ะพะฟะตัะฐัะธะน ะดะปั ะพัะปะฐะดะบะธ ะธ ะผะพะฝะธัะพัะธะฝะณะฐ.

### ะฃัะพะฒะฝะธ ะปะพะณะธัะพะฒะฐะฝะธั

#### DEBUG - ะะพะดัะพะฑะฝะฐั ะพัะปะฐะดะพัะฝะฐั ะธะฝัะพัะผะฐัะธั
- ะะตัะฐะปัะฝะฐั ััะฐััะธัะพะฒะบะฐ ะฒัะฟะพะปะฝะตะฝะธั
- ะกะพััะพัะฝะธะต ะฟะตัะตะผะตะฝะฝัั ะธ ะพะฑัะตะบัะพะฒ
- ะะฐัะฐะผะตััั ััะฝะบัะธะน ะธ API ะฒัะทะพะฒะพะฒ
- ะะตะทัะปััะฐัั ะพะฟะตัะฐัะธะน ั ะฑะฐะทะพะน ะดะฐะฝะฝัั

#### INFO - ะัะฝะพะฒะฝัะต ัะพะฑััะธั
- ะฃัะฟะตัะฝัะต ะพะฟะตัะฐัะธะธ
- ะกัะฐัะธััะธะบะฐ ะธ ะผะตััะธะบะธ
- ะะพะปัะทะพะฒะฐัะตะปััะบะธะต ะดะตะนััะฒะธั
- ะกะธััะตะผะฝัะต ัะพะฑััะธั

#### WARNING - ะัะตะดัะฟัะตะถะดะตะฝะธั
- ะะตััะฐะฝะดะฐััะฝัะต ัะธััะฐัะธะธ
- ะัะพะฑะปะตะผั ั ะดะพัััะฟะฝะพัััั ัะตัะฒะธัะพะฒ
- ะงะฐััะธัะฝัะต ัะฑะพะธ

#### ERROR - ะัะธัะธัะตัะบะธะต ะพัะธะฑะบะธ
- ะกะฑะพะธ ะฒ ัะฐะฑะพัะต ัะธััะตะผั
- ะัะธะฑะบะธ ะฟะพะดะบะปััะตะฝะธั ะบ ะะ
- ะัะพะฑะปะตะผั ั VK API

### ะกัััะบัััะฐ ะปะพะณะพะฒ

#### ะคะฐะนะปะพะฒะพะต ะปะพะณะธัะพะฒะฐะฝะธะต
```
logs/
โโโ centralized_YYYYMMDD_HH.log    # ะฆะตะฝััะฐะปะธะทะพะฒะฐะฝะฝัะต ะปะพะณะธ
โโโ bot_system_YYYYMMDD_HHMM.log  # ะกะธััะตะผะฝัะต ะปะพะณะธ ะฑะพัะฐ
โโโ database_debug_YYYYMMDD_HHMM.log # ะัะปะฐะดะพัะฝัะต ะปะพะณะธ ะะ
```

#### ะะพะณะธัะพะฒะฐะฝะธะต ะฒ ะฑะฐะทั ะดะฐะฝะฝัั
ะขะฐะฑะปะธัะฐ `bot_logs`:
- `id` - ัะฝะธะบะฐะปัะฝัะน ะธะดะตะฝัะธัะธะบะฐัะพั
- `vk_user_id` - ID ะฟะพะปัะทะพะฒะฐัะตะปั VK
- `log_level` - ััะพะฒะตะฝั ะปะพะณะธัะพะฒะฐะฝะธั
- `log_message` - ัะตะบัั ัะพะพะฑัะตะฝะธั
- `created_at` - ะฒัะตะผั ัะพะทะดะฐะฝะธั

### ะะฐัััะพะนะบะฐ ะปะพะณะธัะพะฒะฐะฝะธั

#### ะะพะฝัะธะณััะฐัะธั ะฒ ะบะพะดะต
```python
# ะ centralized_logger.py
class CentralizedLogger:
    def __init__(self):
        self._setup_console_logging()  # ะะพะฝัะพะปั - ัะพะปัะบะพ WARNING/ERROR
        self._setup_file_logging()     # ะคะฐะนะปั - ะฒัะต ััะพะฒะฝะธ
        self._setup_database_logging() # ะะ - ะฒัะต ััะพะฒะฝะธ
    
    def tech_point(self, message: str, user_id: int = 0):
        """ะขะตัะฝะธัะตัะบะฐั ัะตะฟะตัะฝะฐั ัะพัะบะฐ - ะฒัะฒะพะดะธััั ะฒ ะบะพะฝัะพะปั ะธ ะะ"""
        # ะ ะบะพะฝัะพะปั ะฒัะฒะพะดะธะผ ะฝะฐะฟััะผัั
        print(f"{datetime.now().strftime('%Y-%m-%d %H:%M:%S')} - INFO - ๐ {formatted_message}")
        # ะ ะะ ะทะฐะฟะธััะฒะฐะตะผ ะบะฐะบ INFO
        self.log('info', message, user_id)
```

#### ะะตัะตะผะตะฝะฝัะต ะพะบััะถะตะฝะธั
```bash
# ะ .env ัะฐะนะปะต
LOG_LEVEL=INFO                    # ะฃัะพะฒะตะฝั ะปะพะณะธัะพะฒะฐะฝะธั
LOG_TO_DB=true                   # ะะพะณะธัะพะฒะฐะฝะธะต ะฒ ะะ
DEBUG_MODE=false                 # ะะตะถะธะผ ะพัะปะฐะดะบะธ
```

## ๐ค ะะฒัะพะผะฐัะธะทะฐัะธั ะฟัะพัะตััะพะฒ

### โ ะะฒัะพะผะฐัะธะทะธัะพะฒะฐะฝะฝัะต ะฟัะพัะตััั:

#### 1. **ะะฒัะพะผะฐัะธัะตัะบะธะน ะทะฐะฟััะบ PostgreSQL**
```python
# ะัะธ ะธะฝะธัะธะฐะปะธะทะฐัะธะธ DatabaseInterface
postgres_manager = PostgreSQLManager()
postgres_manager.ensure_postgresql_running()  # ะะฒัะพะผะฐัะธัะตัะบะธ ะทะฐะฟััะบะฐะตั PostgreSQL
```

#### 2. **ะะฒัะพะผะฐัะธัะตัะบะพะต ัะพะทะดะฐะฝะธะต ะฑะฐะทั ะดะฐะฝะฝัั**
```python
# ะัะธ ะฟะตัะฒะพะผ ะฟะพะดะบะปััะตะฝะธะธ
postgres_manager.create_database_if_not_exists()  # ะกะพะทะดะฐะตั 'vkinder_db' ะตัะปะธ ะฝะต ัััะตััะฒัะตั
```

#### 3. **ะะฒัะพะผะฐัะธัะตัะบะพะต ัะพะทะดะฐะฝะธะต ัะฐะฑะปะธั**
```python
# ะัะธ ะธะฝะธัะธะฐะปะธะทะฐัะธะธ DatabaseInterface
Base.metadata.create_all(engine)  # ะกะพะทะดะฐะตั ะฒัะต ัะฐะฑะปะธัั ะธะท ะผะพะดะตะปะตะน
```

#### 4. **ะะฒัะพะผะฐัะธัะตัะบะพะต ัะฟัะฐะฒะปะตะฝะธะต ัะตััะธัะผะธ**
```python
# ะัะต API ััะฝะบัะธะธ ะฐะฒัะพะผะฐัะธัะตัะบะธ ัะฟัะฐะฒะปััั ะฟะพะดะบะปััะตะฝะธัะผะธ
with db.get_session() as session:
    # ะะฒัะพะผะฐัะธัะตัะบะพะต ะพัะบัััะธะต/ะทะฐะบัััะธะต ัะตััะธะธ
    pass
```

#### 5. **ะััะธัะพะฒะฐะฝะธะต ััะฐัััะฐ PostgreSQL**
```python
# ะะฟัะธะผะธะทะฐัะธั ะฟัะพะฒะตัะพะบ PostgreSQL
class PostgreSQLManager:
    def __init__(self):
        self._status_cache = None
        self._status_cache_time = 0
        self._cache_timeout = 30  # ะัั ะฝะฐ 30 ัะตะบัะฝะด
    
    def ensure_postgresql_running(self) -> bool:
        # ะัะพะฒะตััะตะผ ะบัั ะฟะตัะตะด ะฟะพะปะฝะพะน ะฟัะพะฒะตัะบะพะน
        if self._status_cache and time.time() - self._status_cache_time < self._cache_timeout:
            return self._status_cache
        # ... ะฟะพะปะฝะฐั ะฟัะพะฒะตัะบะฐ
```

### ๐ง ะััะฝัะต ะฟัะพัะตััั:

#### 1. **ะกะพะทะดะฐะฝะธะต ัะฐะฑะปะธั ัะตัะตะท CLI**
```bash
python src/database/db_cli.py create
```

#### 2. **ะัะธััะบะฐ ะดะฐะฝะฝัั**
```bash
python src/database/db_cli.py clear <table_name>
```

#### 3. **ะฃะฟัะฐะฒะปะตะฝะธะต PostgreSQL**
```bash
python src/database/db_cli.py postgres-start
python src/database/db_cli.py postgres-stop
python src/database/db_cli.py postgres-status
```

#### 4. **ะัะพัะผะพัั ะปะพะณะพะฒ**
```bash
python src/database/db_cli.py logs --limit 20
```

## ๐ง ะัะฐะฒะธะปะฐ ะธัะฟะพะปัะทะพะฒะฐะฝะธั API

### 1. **ะะฝะธัะธะฐะปะธะทะฐัะธั ะฟะพะดะบะปััะตะฝะธั**

```python
# ะะฒัะพะผะฐัะธัะตัะบะฐั ะธะฝะธัะธะฐะปะธะทะฐัะธั ะฟัะธ ะธะผะฟะพััะต
from database.db_api import save_user, get_user

# ะััะฝะฐั ะธะฝะธัะธะฐะปะธะทะฐัะธั (ะตัะปะธ ะฝัะถะฝะพ)
from database.database_interface import DatabaseInterface
db = DatabaseInterface()
```

### 2. **ะะฑัะฐะฑะพัะบะฐ ะพัะธะฑะพะบ**

```python
try:
    success = save_user(user_data)
    if success:
        print("ะะฟะตัะฐัะธั ะฒัะฟะพะปะฝะตะฝะฐ ััะฟะตัะฝะพ")
    else:
        print("ะัะธะฑะบะฐ ะฒัะฟะพะปะฝะตะฝะธั ะพะฟะตัะฐัะธะธ")
except Exception as e:
    print(f"ะัะธัะธัะตัะบะฐั ะพัะธะฑะบะฐ: {e}")
```

### 3. **ะัะพะฒะตัะบะฐ ัััะตััะฒะพะฒะฐะฝะธั ะดะฐะฝะฝัั**

```python
# ะัะตะณะดะฐ ะฟัะพะฒะตััะนัะต ัะตะทัะปััะฐั ะฟะตัะตะด ะธัะฟะพะปัะทะพะฒะฐะฝะธะตะผ
user = get_user(user_id)
if user:
    # ะะพะปัะทะพะฒะฐัะตะปั ะฝะฐะนะดะตะฝ
    print(f"ะะพะปัะทะพะฒะฐัะตะปั: {user['first_name']}")
else:
    # ะะพะปัะทะพะฒะฐัะตะปั ะฝะต ะฝะฐะนะดะตะฝ
    print("ะะพะปัะทะพะฒะฐัะตะปั ะฝะต ะฝะฐะนะดะตะฝ")
```

### 4. **ะัะฟะพะปัะทะพะฒะฐะฝะธะต ััะฐะฝะทะฐะบัะธะน**

```python
# API ะฐะฒัะพะผะฐัะธัะตัะบะธ ัะฟัะฐะฒะปัะตั ััะฐะฝะทะฐะบัะธัะผะธ
# ะะฐะถะดะฐั ััะฝะบัะธั ะฒัะฟะพะปะฝัะตััั ะฒ ัะฒะพะตะน ััะฐะฝะทะฐะบัะธะธ
# ะัะธ ะพัะธะฑะบะต ััะฐะฝะทะฐะบัะธั ะพัะบะฐััะฒะฐะตััั ะฐะฒัะพะผะฐัะธัะตัะบะธ
```

## ๐จ ะะฐะถะฝัะต ะพะณัะฐะฝะธัะตะฝะธั

### 1. **ะขะธะฟั ะดะฐะฝะฝัั**
- `user_id` ะฒัะตะณะดะฐ ะดะพะปะถะตะฝ ะฑััั `int`
- `city` ะดะพะปะถะตะฝ ะฑััั ัะปะพะฒะฐัะตะผ ั ะบะปััะฐะผะธ `id` ะธ `title`
- `sex` ะดะพะปะถะตะฝ ะฑััั `1` (ะถะตะฝัะบะธะน) ะธะปะธ `2` (ะผัะถัะบะพะน)

### 2. **ะะณัะฐะฝะธัะตะฝะธั ะฑะฐะทั ะดะฐะฝะฝัั**
- ะะฐะบัะธะผะฐะปัะฝะฐั ะดะปะธะฝะฐ ัะพะพะฑัะตะฝะธั: 1000 ัะธะผะฒะพะปะพะฒ
- ะะฐะบัะธะผะฐะปัะฝะฐั ะดะปะธะฝะฐ URL ัะพัะพะณัะฐัะธะธ: 500 ัะธะผะฒะพะปะพะฒ
- ะะฐะบัะธะผะฐะปัะฝะฐั ะดะปะธะฝะฐ ะธะผะตะฝะธ/ัะฐะผะธะปะธะธ: 100 ัะธะผะฒะพะปะพะฒ

### 3. **ะัะพะธะทะฒะพะดะธัะตะปัะฝะพััั**
- ะัะฟะพะปัะทัะนัะต `get_all_tables_info()` ะฒะผะตััะพ ะผะฝะพะถะตััะฒะตะฝะฝัั ะฒัะทะพะฒะพะฒ `get_table_info()`
- ะะปั ะฑะพะปััะธั ะฒัะฑะพัะพะบ ะธัะฟะพะปัะทัะนัะต ะฟะฐัะฐะผะตัั `limit`
- ะะทะฑะตะณะฐะนัะต ัะฐัััั ะฒัะทะพะฒะพะฒ `get_database_stats()`

## ๐ ะัะปะฐะดะบะฐ ะธ ะผะพะฝะธัะพัะธะฝะณ

### ะะพะณะธัะพะฒะฐะฝะธะต
```python
import logging
logger = logging.getLogger('database')

# API ะฐะฒัะพะผะฐัะธัะตัะบะธ ะปะพะณะธััะตั ะฒัะต ะพะฟะตัะฐัะธะธ
# ะฃัะพะฒะฝะธ ะปะพะณะธัะพะฒะฐะฝะธั: DEBUG, INFO, WARNING, ERROR
```

### ะัะพะฒะตัะบะฐ ัะพััะพัะฝะธั
```python
from database.db_api import get_database_stats

stats = get_database_stats()
print(f"ะัะตะณะพ ะฟะพะปัะทะพะฒะฐัะตะปะตะน: {stats.get('vk_users', 0)}")
print(f"ะัะตะณะพ ัะพะพะฑัะตะฝะธะน: {stats.get('bot_messages', 0)}")
```

## ๐ ะัะธะผะตัั ะธัะฟะพะปัะทะพะฒะฐะฝะธั

### ะะพะปะฝัะน ัะธะบะป ัะฐะฑะพัั ั ะฟะพะปัะทะพะฒะฐัะตะปะตะผ

```python
from database.db_api import *

# 1. ะกะพััะฐะฝะตะฝะธะต ะฟะพะปัะทะพะฒะฐัะตะปั
user_data = {
    'id': 123456789,
    'first_name': 'ะะฝะฝะฐ',
    'last_name': 'ะะตััะพะฒะฐ',
    'sex': 1,
    'bdate': '15.05.1990',
    'city': {'id': 1, 'title': 'ะะพัะบะฒะฐ'},
    'photo_url': 'https://vk.com/photo123'
}

if save_user(user_data):
    print("ะะพะปัะทะพะฒะฐัะตะปั ัะพััะฐะฝะตะฝ")

# 2. ะกะพััะฐะฝะตะฝะธะต ัะพัะพะณัะฐัะธะน
photos_data = [
    {
        'url': 'https://vk.com/photo123',
        'likes_count': 15,
        'photo_type': 'profile'
    },
    {
        'url': 'https://vk.com/photo124',
        'likes_count': 8,
        'photo_type': 'tagged'
    }
]

if save_photos(123456789, photos_data):
    print("ะคะพัะพะณัะฐัะธะธ ัะพััะฐะฝะตะฝั")

# 3. ะะพะฑะฐะฒะปะตะฝะธะต ะฒ ะธะทะฑัะฐะฝะฝะพะต
if add_to_favorites(987654321, 123456789):
    print("ะะพะปัะทะพะฒะฐัะตะปั ะดะพะฑะฐะฒะปะตะฝ ะฒ ะธะทะฑัะฐะฝะฝะพะต")

# 4. ะกะพััะฐะฝะตะฝะธะต ะฝะฐัััะพะตะบ
settings = {
    'age_from': 25,
    'age_to': 35,
    'sex_preference': 2,
    'city_preference': {'id': 1, 'title': 'ะะพัะบะฒะฐ'}
}

if save_user_settings(987654321, settings):
    print("ะะฐัััะพะนะบะธ ัะพััะฐะฝะตะฝั")

# 5. ะะพะปััะตะฝะธะต ะดะฐะฝะฝัั
user = get_user(123456789)
favorites = get_favorites(987654321, limit=5)
photos = get_photos(123456789)
```

### ะะฐะฑะพัะฐ ั ะธะทะฑัะฐะฝะฝัะผ ะธ ัะตัะฝัะผ ัะฟะธัะบะพะผ

```python
# ะัะพะฒะตัะบะฐ ะฟะตัะตะด ะดะพะฑะฐะฒะปะตะฝะธะตะผ
if not is_in_favorites(user_id, target_id):
    add_to_favorites(user_id, target_id)
    print("ะะพะฑะฐะฒะปะตะฝะพ ะฒ ะธะทะฑัะฐะฝะฝะพะต")
else:
    print("ะฃะถะต ะฒ ะธะทะฑัะฐะฝะฝะพะผ")

# ะัะพะฒะตัะบะฐ ัะตัะฝะพะณะพ ัะฟะธัะบะฐ ะฟะตัะตะด ะฟะพะบะฐะทะพะผ
if not is_user_blacklisted(user_id, target_id):
    # ะะพะบะฐะทะฐัั ะฟะพะปัะทะพะฒะฐัะตะปั
    pass
else:
    # ะัะพะฟัััะธัั ะฟะพะปัะทะพะฒะฐัะตะปั
    pass
```

### ะะพะปะฝัะน ัะธะบะป ัะฐะฑะพัั ั ัะพะบะตะฝะฐะผะธ

```python
from src.database.database_interface import DatabaseInterface

# ะะฝะธัะธะฐะปะธะทะฐัะธั
db_interface = DatabaseInterface()

user_id = 9197005

# 1. ะกะพััะฐะฝะตะฝะธะต ัะพะบะตะฝะพะฒ
success = db_interface.save_user_tokens(
    vk_user_id=user_id,
    access_token="vk1.a.new_token...",
    refresh_token="vk2.a.refresh_token...",
    expires_in=3600
)

if success:
    print("โ ะขะพะบะตะฝั ัะพััะฐะฝะตะฝั ะธ ะทะฐัะธััะพะฒะฐะฝั")

# 2. ะะพะปััะตะฝะธะต ัะพะบะตะฝะพะฒ
access_token = db_interface.get_user_access_token(user_id)
refresh_token = db_interface.get_user_refresh_token_decrypted(user_id)

if access_token:
    print(f"โ Access ัะพะบะตะฝ ะฟะพะปััะตะฝ: {access_token[:20]}...")

# 3. ะัะพะฒะตัะบะฐ ัะพะบะตะฝะพะฒ
is_expired = db_interface.is_user_token_expired(user_id)
is_valid = db_interface.verify_user_refresh_token(user_id, refresh_token)

print(f"ะขะพะบะตะฝ ะธััะตะบ: {is_expired}")
print(f"Refresh ัะพะบะตะฝ ะฒะฐะปะธะดะตะฝ: {is_valid}")

# 4. ะะพะปััะตะฝะธะต ะธะฝัะพัะผะฐัะธะธ ะพ ัะพะบะตะฝะฐั
token_info = db_interface.get_user_token_info(user_id)
print(f"ะกัะฐััั ัะพะบะตะฝะพะฒ: {token_info['token_status']}")

# 5. ะะฑะฝะพะฒะปะตะฝะธะต ัะพะบะตะฝะพะฒ
success = db_interface.update_user_tokens(
    vk_user_id=user_id,
    access_token="vk1.a.updated_token...",
    expires_in=3600
)

if success:
    print("โ ะขะพะบะตะฝั ะพะฑะฝะพะฒะปะตะฝั")

# 6. ะัะธััะบะฐ ัะพะบะตะฝะพะฒ (ะฟัะธ ะฝะตะพะฑัะพะดะธะผะพััะธ)
# success = db_interface.clear_user_tokens(user_id)
```

## ๐๏ธ ะฃัััะฐะฝะตะฝะธะต ะฝะตะฟะพะปะฐะดะพะบ

### ะงะฐัััะต ะฟัะพะฑะปะตะผั:

1. **ะัะธะฑะบะฐ ะฟะพะดะบะปััะตะฝะธั ะบ ะฑะฐะทะต ะดะฐะฝะฝัั**
   - ะัะพะฒะตัััะต, ะทะฐะฟััะตะฝ ะปะธ PostgreSQL
   - ะัะพะฒะตัััะต ะฝะฐัััะพะนะบะธ ะฒ `.env` ัะฐะนะปะต

2. **ะัะธะฑะบะฐ "table does not exist"**
   - ะัะฟะพะปะฝะธัะต `python src/database/db_cli.py create`

3. **ะัะธะฑะบะฐ "foreign key constraint"**
   - ะฃะฑะตะดะธัะตัั, ััะพ ะฟะพะปัะทะพะฒะฐัะตะปั ัััะตััะฒัะตั ะฟะตัะตะด ัะพััะฐะฝะตะฝะธะตะผ ัะฒัะทะฐะฝะฝัั ะดะฐะฝะฝัั

4. **ะะตะดะปะตะฝะฝะฐั ัะฐะฑะพัะฐ**
   - ะัะฟะพะปัะทัะนัะต `get_all_tables_info()` ะฒะผะตััะพ ะผะฝะพะถะตััะฒะตะฝะฝัั ะฒัะทะพะฒะพะฒ
   - ะัะพะฒะตัััะต ะธะฝะดะตะบัั ะฒ ะฑะฐะทะต ะดะฐะฝะฝัั

### ะะพะผะฐะฝะดั ะดะปั ะดะธะฐะณะฝะพััะธะบะธ:

```bash
# ะัะพะฒะตัะบะฐ ััะฐัััะฐ PostgreSQL
python src/database/db_cli.py postgres-status

# ะัะพัะผะพัั ะปะพะณะพะฒ
python src/database/db_cli.py logs

# ะัะธััะบะฐ ะดะฐะฝะฝัั (ะะกะขะะะะะะ!)
python src/database/db_cli.py clear
```

## ๐ ะกะฟัะฐะฒะพัะฝะฐั ัะฐะฑะปะธัะฐ ะบะพะผะฐะฝะด

| ะะพะผะฐะฝะดะฐ | ะะฐัะฐะผะตััั | ะะฟะธัะฐะฝะธะต | ะัะธะผะตั |
|---------|-----------|----------|--------|
| `create` | - | ะกะพะทะดะฐะฝะธะต ะฒัะตั ัะฐะฑะปะธั | `python src/database/db_cli.py create` |
| `drop` | - | ะฃะดะฐะปะตะฝะธะต ะฒัะตั ัะฐะฑะปะธั | `python src/database/db_cli.py drop` |
| `clear <table>` | `table` - ะฝะฐะทะฒะฐะฝะธะต ัะฐะฑะปะธัั | ะัะธััะบะฐ ัะฐะฑะปะธัั | `python src/database/db_cli.py clear bot_logs` |
| `clear-all` | - | ะัะธััะบะฐ ะฒัะตั ัะฐะฑะปะธั | `python src/database/db_cli.py clear-all` |
| `info` | - | ะะฝัะพัะผะฐัะธั ะพ ะะ | `python src/database/db_cli.py info` |
| `logs` | `--user <id>`, `--level <level>`, `--limit <n>` | ะัะพัะผะพัั ะปะพะณะพะฒ | `python src/database/db_cli.py logs --level ERROR` |
| `messages <user_id>` | `--limit <n>` | ะกะพะพะฑัะตะฝะธั ะฟะพะปัะทะพะฒะฐัะตะปั | `python src/database/db_cli.py messages 123456` |
| `favorites <user_id>` | - | ะะทะฑัะฐะฝะฝัะต ะฟะพะปัะทะพะฒะฐัะตะปั | `python src/database/db_cli.py favorites 123456` |
| `test-data` | - | ะขะตััะพะฒัะต ะดะฐะฝะฝัะต | `python src/database/db_cli.py test-data` |
| `postgres-start` | - | ะะฐะฟััะบ PostgreSQL | `python src/database/db_cli.py postgres-start` |
| `postgres-stop` | - | ะััะฐะฝะพะฒะบะฐ PostgreSQL | `python src/database/db_cli.py postgres-stop` |
| `postgres-restart` | - | ะะตัะตะทะฐะฟััะบ PostgreSQL | `python src/database/db_cli.py postgres-restart` |
| `postgres-status` | - | ะกัะฐััั PostgreSQL | `python src/database/db_cli.py postgres-status` |
| `postgres-info` | - | ะะฝัะพัะผะฐัะธั ะพ PostgreSQL | `python src/database/db_cli.py postgres-info` |

## ๐ก ะกะพะฒะตัั ะฟะพ ะธัะฟะพะปัะทะพะฒะฐะฝะธั

### 1. **ะะตะณัะปััะฝะพะต ะพะฑัะปัะถะธะฒะฐะฝะธะต**
```bash
# ะะถะตะฝะตะดะตะปัะฝะฐั ะพัะธััะบะฐ ะปะพะณะพะฒ
python src/database/db_cli.py clear bot_logs

# ะัะพะฒะตัะบะฐ ััะฐัััะฐ ัะธััะตะผั
python src/database/db_cli.py info
```

### 2. **ะะพะฝะธัะพัะธะฝะณ ะฟัะพะธะทะฒะพะดะธัะตะปัะฝะพััะธ**
```bash
# ะัะพัะผะพัั ััะฐัะธััะธะบะธ
python src/database/db_cli.py info

# ะะฝะฐะปะธะท ะพัะธะฑะพะบ
python src/database/db_cli.py logs --level ERROR --limit 20
```

### 3. **ะะตะทะพะฟะฐัะฝะพััั**
- ะัะตะณะดะฐ ะดะตะปะฐะนัะต ัะตะทะตัะฒะฝัะต ะบะพะฟะธะธ ะฟะตัะตะด `drop` ะธะปะธ `clear-all`
- ะัะฟะพะปัะทัะนัะต `--limit` ะดะปั ะฑะพะปััะธั ัะฐะฑะปะธั
- ะัะพะฒะตััะนัะต ััะฐััั PostgreSQL ะฟะตัะตะด ะพะฟะตัะฐัะธัะผะธ

### 4. **ะัะปะฐะดะบะฐ**
```bash
# ะะพะปะฝะฐั ะดะธะฐะณะฝะพััะธะบะฐ
python src/database/db_cli.py postgres-info
python src/database/db_cli.py info
python src/database/db_cli.py logs --level ERROR
```

## โ๏ธ ะะฐัััะพะนะบะฐ

### ะคะฐะนะป .env
```env
# PostgreSQL ะฝะฐัััะพะนะบะธ
DB_HOST=localhost
DB_PORT=5433
DB_NAME=vkinder_db
DB_USER=vkinder_user
DB_PASSWORD=vkinder123

# ะะพะณะธัะพะฒะฐะฝะธะต
LOG_LEVEL=INFO
LOG_TO_DB=true
DEBUG_MODE=false

# ะขะพะบะตะฝั
VK_APP_ID=your_app_id
VK_APP_SECRET=your_app_secret
VK_USER_TOKEN=your_user_token
VK_REFRESH_TOKEN=your_refresh_token
VK_TOKEN_EXPIRES_IN=3600
TOKEN_ENCRYPTION_KEY=your_encryption_key
```

### ะกะพะทะดะฐะฝะธะต ะฑะฐะทั ะดะฐะฝะฝัั
```bash
# ะกะพะทะดะฐะฝะธะต ะฟะพะปัะทะพะฒะฐัะตะปั ะธ ะฑะฐะทั
createdb vkinder_db
createuser vkinder_user
psql -c "ALTER USER vkinder_user PASSWORD 'vkinder123';"
psql -c "GRANT ALL PRIVILEGES ON DATABASE vkinder_db TO vkinder_user;"
```

## ๐ ะัะพะธะทะฒะพะดะธัะตะปัะฝะพััั

### ะะฟัะธะผะธะทะฐัะธั ะทะฐะฟัะพัะพะฒ
- **ะะฝะดะตะบัั** - ััะบะพัะตะฝะธะต ะฟะพะธัะบะฐ ะฟะพ ะบะปััะตะฒัะผ ะฟะพะปัะผ
- **ะััะธัะพะฒะฐะฝะธะต** - ะบััะธัะพะฒะฐะฝะธะต ัะฐััะพ ะธัะฟะพะปัะทัะตะผัั ะดะฐะฝะฝัั
- **ะะฐััะตะฒัะต ะพะฟะตัะฐัะธะธ** - ะณััะฟะฟะธัะพะฒะบะฐ ะพะฟะตัะฐัะธะน ะดะปั ะฟะพะฒััะตะฝะธั ะฟัะพะธะทะฒะพะดะธัะตะปัะฝะพััะธ

### ะะพะฝะธัะพัะธะฝะณ
- **ะัะตะผั ะฒัะฟะพะปะฝะตะฝะธั** - ะพััะปะตะถะธะฒะฐะฝะธะต ะฟัะพะธะทะฒะพะดะธัะตะปัะฝะพััะธ ะทะฐะฟัะพัะพะฒ
- **ะัะฟะพะปัะทะพะฒะฐะฝะธะต ัะตััััะพะฒ** - ะผะพะฝะธัะพัะธะฝะณ ะฟะฐะผััะธ ะธ CPU
- **ะะปะตััั** - ัะฒะตะดะพะผะปะตะฝะธั ะพ ะฟัะพะฑะปะตะผะฐั

## ๐ง ะะฝัะตะณัะฐัะธั ั ะฑะพัะพะผ

### ะะพะดัะปั ะธะฝัะตะณัะฐัะธะธ ั ะฑะฐะทะพะน ะดะฐะฝะฝัั
- **ะคะฐะนะป:** `src/bot/database_integration.py`
- **ะคัะฝะบัะธะธ:** ะกะพััะฐะฝะตะฝะธะต ะฒัะตั ะดะฐะฝะฝัั ะฒ ัะพะพัะฒะตัััะฒัััะธะต ัะฐะฑะปะธัั
- **ะะฑัะฐะฑะพัะบะฐ ะพัะธะฑะพะบ:** Graceful fallback ะฟัะธ ะฝะตะดะพัััะฟะฝะพััะธ ะะ
- **ะะพะฒะฐั ะปะพะณะธะบะฐ:** ะัะพะฒะตัะบะฐ ััะฟะตัะฝะพััะธ ัะพััะฐะฝะตะฝะธั ะฟะตัะตะด ัะพััะฐะฝะตะฝะธะตะผ ัะฒัะทะฐะฝะฝัั ะดะฐะฝะฝัั
- **ะัะฟัะฐะฒะปะตะฝะธั:** Foreign key constraint errors, ะฟัะฐะฒะธะปัะฝัะน ะฟะพััะดะพะบ ัะพััะฐะฝะตะฝะธั

### ะะฐะฟะธัั ะดะฐะฝะฝัั ะฒะพ ะฒัะต ัะฐะฑะปะธัั

#### **๐ ะขะฐะฑะปะธัะฐ `vk_users`:**
```python
# ะกะพััะฐะฝะตะฝะธะต ะฟะพะปัะทะพะฒะฐัะตะปะตะน ะฟัะธ ะฟะพะปััะตะฝะธะธ ะธะฝัะพัะผะฐัะธะธ
user_data = {
    'id': user_id,
    'first_name': user['first_name'],
    'last_name': user['last_name'],
    'age': age,
    'sex': user.get('sex', 0),
    'city': city,
    'city_id': city_id,
    'country': user.get('country', ''),
    'bdate': user.get('bdate', ''),
    'photo_url': f"https://vk.com/images/camera_200.png",
    'profile_url': f"https://vk.com/id{user_id}",
    'is_closed': user.get('is_closed', False),
    'can_access_closed': user.get('can_access_closed', False)
}
self.db.save_user(user_data)
```

#### **๐ธ ะขะฐะฑะปะธัะฐ `photos`:**
```python
# ะกะพััะฐะฝะตะฝะธะต ัะพัะพะณัะฐัะธะน ะฟัะธ ะฟะพะธัะบะต
photos_data = []
for photo in top_photos:
    photo_data = {
        'url': max_size['url'],
        'type': 'profile',
        'likes': photo.get('likes', {}).get('count', 0)
    }
    photos_data.append(photo_data)
self.db.save_photos(user_id, photos_data)
```

#### **โค๏ธ ะขะฐะฑะปะธัะฐ `favorites`:**
```python
# ะกะพััะฐะฝะตะฝะธะต ะธะทะฑัะฐะฝะฝัั ะฟะพะปัะทะพะฒะฐัะตะปะตะน
self.db.add_to_favorites(user_id, person_id)
```

#### **๐ซ ะขะฐะฑะปะธัะฐ `blacklisted`:**
```python
# ะกะพััะฐะฝะตะฝะธะต ะทะฐะฑะปะพะบะธัะพะฒะฐะฝะฝัั ะฟะพะปัะทะพะฒะฐัะตะปะตะน
self.db.add_to_blacklist(user_id, person_id)
```

#### **๐ ะขะฐะฑะปะธัะฐ `search_history`:**
```python
# ะกะพััะฐะฝะตะฝะธะต ะธััะพัะธะธ ะฟะพะธัะบะฐ
search_data = {
    'user_id': user_id,
    'search_params': search_params,
    'results_count': len(results),
    'timestamp': datetime.now()
}
self.db.save_search_history(search_data)
```

#### **โ๏ธ ะขะฐะฑะปะธัะฐ `user_settings`:**
```python
# ะกะพััะฐะฝะตะฝะธะต ะฝะฐัััะพะตะบ ะฟะพะปัะทะพะฒะฐัะตะปั
settings_data = {
    'user_id': user_id,
    'min_age': min_age,
    'max_age': max_age,
    'sex_preference': sex_preference,
    'city_preference': city_preference
}
self.db.save_user_settings(settings_data)
```

#### **๐ ะขะฐะฑะปะธัะฐ `bot_logs`:**
```python
# ะะพะณะธัะพะฒะฐะฝะธะต ะฒ ะฑะฐะทั ะดะฐะฝะฝัั
self.db.log_to_database("info", "ะะพะปัะทะพะฒะฐัะตะปั ะฒัะฟะพะปะฝะธะป ะฟะพะธัะบ", user_id)
```

#### **๐ฌ ะขะฐะฑะปะธัะฐ `bot_messages`:**
```python
# ะกะพััะฐะฝะตะฝะธะต ัะพะพะฑัะตะฝะธะน ะฑะพัะฐ
self.db.save_bot_message(user_id, "command", message_text)
self.db.save_bot_message(user_id, "response", response_text)
```

## ๐ ะะธัะตะฝะทะธั

ะัะพะตะบั ัะพะทะดะฐะฝ ะดะปั ััะตะฑะฝัั ัะตะปะตะน.

---

*ะะพะปะฝะฐั ัะธััะตะผะฐ ัะฟัะฐะฒะปะตะฝะธั ะฑะฐะทะพะน ะดะฐะฝะฝัั PostgreSQL ั ะฐะฒัะพะผะฐัะธะทะฐัะธะตะน, ัะธััะพะฒะฐะฝะธะตะผ ัะพะบะตะฝะพะฒ, ะปะพะณะธัะพะฒะฐะฝะธะตะผ ะธ ะธะฝัะตะณัะฐัะธะตะน ั ะฑะพัะพะผ!*
